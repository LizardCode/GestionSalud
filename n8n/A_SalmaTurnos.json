{
  "name": "A_SalmaTurnos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ac247fd3-9ca7-42a3-8942-7ea8c321c46d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3600,
        420
      ],
      "id": "05ac3210-8db8-4c4e-a92d-7c8e5160e7ec",
      "name": "Webhook",
      "webhookId": "ac247fd3-9ca7-42a3-8942-7ea8c321c46d"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst message = items[0].json.body.data.message;\n\n\n\nif (!message) {\n  return [{ json: { error: \"No message found\" } }];\n}\n\nif (message.type !=='chat') {\n  return null;\n}\n\n\n\n\nconst chatId = message.from;\nconst messageText = message.body?.trim();\nconst messageId = message.id;\n\n// Limpiar chatId - remover @c.us si existe\n// if (chatId.includes('@c.us')) {\n//   chatId = chatId.replace('@c.us', '');\n// }\n\n// Tambi√©n limpiar otros formatos posibles\n// chatId = chatId.replace('@g.us', '').replace('@newsletter', '');\n\nreturn {\n  json: {\n    chatId: chatId,\n    messageText: messageText,\n    messageId: messageId,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3180,
        360
      ],
      "id": "a0a78d48-101f-438f-beb4-be96d1a8b1e6",
      "name": "menssageIn"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Get User Session (JSONBin version)\nconst chatId = $('menssageIn').first().json.chatId;\nconst messageText = $('menssageIn').first().json.messageText;\n\n// Los datos vienen del HTTP Request \"Read JSONBin\"\nlet allSessions = {};\nlet userSession = null;\n\ntry {\n  // JSONBin devuelve la data en $json.record.sessions\n   const jsonbinData = $('Read JSONBin').first().json;\n  \n if (jsonbinData.record) {\n    allSessions = jsonbinData.record;  // Los datos est√°n directamente en record\n    userSession = allSessions[chatId];\n    console.log('Sesiones en JSONBin:', Object.keys(allSessions).length);\n    console.log('Sesi√≥n encontrada:', userSession ? 'S√ç' : 'NO');\n}\n  \n  console.log('=== JSONBin READ ===');\n  console.log('ChatId buscado:', chatId);\n  console.log('Total sesiones:', Object.keys(allSessions).length);\n  console.log('Sesi√≥n encontrada:', userSession ? 'S√ç' : 'NO');\n  if (userSession) {\n    console.log('Estado actual:', userSession.estado);\n  }\n  console.log('==================');\n} catch (error) {\n  console.log('Error leyendo JSONBin:', error.message);\n}\n\nif (!userSession) {\n  userSession = {\n    chatId: chatId,\n    estado: \"INICIO\",\n    datos: {},\n    createdAt: new Date().toISOString(),\n    lastActivity: new Date().toISOString()\n  };\n  console.log('==> Creando NUEVA sesi√≥n');\n} else {\n  userSession.lastActivity = new Date().toISOString();\n  console.log('==> Sesi√≥n EXISTENTE, estado:', userSession.estado);\n}\n\nreturn {\n  json: {\n    chatId: chatId,\n    messageText: messageText,\n    userSession: userSession,\n    debug: {\n      sessionExists: !!allSessions[chatId],\n      currentState: userSession.estado\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2840,
        120
      ],
      "id": "b4cd0962-da02-4785-9b4e-18bfe2d720cc",
      "name": "Get User Session"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Process Step Logic (CON SELECCI√ìN M√öLTIPLE Y VALIDACI√ìN DNI MEJORADA)\nconst messageText = $json.messageText.toLowerCase();\nconst userSession = $json.userSession;\nconst chatId = $json.chatId;\nconst maestros = $('Format Maestros').first().json;\n\nlet response = {};\nlet newEstado = userSession.estado;\nlet updateData = { ...userSession.datos };\nlet isValid = true;\nlet errorMessage = \"\";\n\n// Funci√≥n auxiliar para parsear selecci√≥n m√∫ltiple\nfunction parseMultipleSelection(input, validOptions) {\n  console.log('=== PARSE MULTIPLE SELECTION ===');\n  console.log('Input:', input);\n  console.log('Valid options:', Object.keys(validOptions));\n  \n  if (!input || typeof input !== 'string') {\n    console.log('Invalid input type');\n    return {\n      valid: false,\n      selections: [],\n      invalidItems: [input]\n    };\n  }\n  \n  const selections = input.split(',').map(item => item.trim()).filter(item => item.length > 0);\n  const validSelections = [];\n  const invalidItems = [];\n  \n  console.log('Parsed selections:', selections);\n  \n  for (const selection of selections) {\n    if (validOptions.hasOwnProperty(selection)) {\n      validSelections.push({\n        id: selection,\n        value: validOptions[selection]\n      });\n      console.log(`Valid selection: ${selection} -> ${validOptions[selection]}`);\n    } else {\n      invalidItems.push(selection);\n      console.log(`Invalid selection: ${selection}`);\n    }\n  }\n  \n  const result = {\n    valid: invalidItems.length === 0 && validSelections.length > 0,\n    selections: validSelections,\n    invalidItems: invalidItems\n  };\n  \n  console.log('Final result:', JSON.stringify(result, null, 2));\n  console.log('================================');\n  \n  return result;\n}\n\nswitch (userSession.estado) {\n  case \"INICIO\":\n    // Cualquier mensaje inicia el proceso\n    response = {\n      message: \"üè• *Bienvenido al Sistema de Turnos*\\n\\nPor favor, indique su DNI (solo n√∫meros, sin puntos):\",\n      nextStep: \"ESPERANDO_DNI\"\n    };\n    newEstado = \"ESPERANDO_DNI\";\n    break;\n\n  case \"COMPLETADO\":\n    // NUEVO CASO: Usuario que ya complet√≥ un turno quiere hacer otro\n    console.log('=== REINICIANDO USUARIO COMPLETADO ===');\n    console.log('Usuario:', chatId);\n    console.log('Estado anterior:', userSession.estado);\n    console.log('Datos anteriores:', JSON.stringify(userSession.datos, null, 2));\n    \n    // Limpiar datos y reiniciar\n    updateData = {};\n    response = {\n      message: \"üè• *Bienvenido nuevamente al Sistema de Turnos*\\n\\n¬øDesea agendar un nuevo turno?\\n\\nPor favor, indique su DNI (solo n√∫meros, sin puntos):\",\n      nextStep: \"ESPERANDO_DNI\"\n    };\n    newEstado = \"ESPERANDO_DNI\";\n    \n    console.log('Nuevo estado:', newEstado);\n    console.log('Datos limpiados:', JSON.stringify(updateData, null, 2));\n    console.log('=====================================');\n    break;\n\n  case \"ESPERANDO_DNI\":\n    const dniInput = $json.messageText.trim();\n    \n    console.log('=== VALIDACI√ìN DNI DEBUG ===');\n    console.log('Input original:', JSON.stringify(dniInput));\n    console.log('Input length:', dniInput.length);\n    console.log('Input chars:', dniInput.split('').map(c => c.charCodeAt(0)));\n    \n    // Limpiar DNI: quitar espacios, puntos, comas, guiones\n    const cleanDNI = dniInput\n      .replace(/\\s+/g, '')        // Quitar espacios\n      .replace(/\\./g, '')         // Quitar puntos\n      .replace(/,/g, '')          // Quitar comas  \n      .replace(/-/g, '')          // Quitar guiones\n      .replace(/[^\\d]/g, '');     // Quitar cualquier car√°cter que no sea d√≠gito\n    \n    console.log('DNI limpio:', cleanDNI);\n    console.log('DNI length:', cleanDNI.length);\n    console.log('Es solo n√∫meros:', /^\\d+$/.test(cleanDNI));\n    console.log('===========================');\n    \n    // Validar DNI limpio (solo n√∫meros, 7-8 d√≠gitos)\n    if (!cleanDNI || cleanDNI.length < 7 || cleanDNI.length > 8 || !/^\\d+$/.test(cleanDNI)) {\n      isValid = false;\n      errorMessage = `‚ùå *DNI inv√°lido*\\n\\nPor favor ingrese solo n√∫meros, entre 7 y 8 d√≠gitos.\\n\\nüìù *Formatos aceptados:*\\n‚Ä¢ 25430441\\n‚Ä¢ 25.430.441\\n‚Ä¢ 25 430 441\\n\\n‚ö†Ô∏è *Su entrada:* \"${dniInput}\"\\nüí° *Procesado como:* \"${cleanDNI}\"`;\n      \n      console.log('‚ùå DNI INV√ÅLIDO - Raz√≥n:', {\n        empty: !cleanDNI,\n        tooShort: cleanDNI.length < 7,\n        tooLong: cleanDNI.length > 8,\n        notNumbers: !/^\\d+$/.test(cleanDNI),\n        length: cleanDNI.length\n      });\n    } else {\n      updateData.dni = cleanDNI; // Guardar DNI limpio\n      \n      console.log('‚úÖ DNI V√ÅLIDO:', cleanDNI);\n      \n      // Obtener especialidades del maestro\n      const especialidades = maestros.especialidades;\n      \n      let especialidadesText = \"üë®‚Äç‚öïÔ∏è *Seleccione una especialidad:*\\n\\n\";\n      especialidades.forEach(esp => {\n        especialidadesText += `${esp.idEspecialidad}. ${esp.descripcion}\\n`;\n      });\n      \n      response = {\n        message: especialidadesText,\n        nextStep: \"ESPERANDO_ESPECIALIDAD\"\n      };\n      newEstado = \"ESPERANDO_ESPECIALIDAD\";\n    }\n    break;\n\n  case \"ESPERANDO_ESPECIALIDAD\":\n    const especialidadId = parseInt($json.messageText.trim());\n    const especialidad = maestros.especialidades.find(e => e.idEspecialidad === especialidadId);\n    \n    if (!especialidad) {\n      isValid = false;\n      let opciones = maestros.especialidades.map(e => `${e.idEspecialidad}. ${e.descripcion}`).join('\\n');\n      errorMessage = `‚ùå *No se reconoce el valor ingresado*\\n\\nOpciones v√°lidas:\\n${opciones}`;\n    } else {\n      updateData.especialidad = especialidad;\n      \n      // En lugar de mostrar d√≠as inmediatamente, configurar para activar el flujo din√°mico\n      response = {\n        message: \"‚è≥ *Procesando especialidad seleccionada...*\\n\\nObteniendo d√≠as disponibles para ${especialidad.descripcion}.\",\n        nextStep: \"ESPERANDO_DIA\",\n        triggerDynamicFlow: true\n      };\n      newEstado = \"ESPERANDO_DIA\";\n      \n      console.log('=== ESPECIALIDAD SELECTED FOR DYNAMIC FLOW ===');\n      console.log('Especialidad seleccionada:', especialidad);\n      console.log('Activando flujo din√°mico para obtener d√≠as y horarios');\n      console.log('=============================================');\n    }\n    break;\n\n  case \"ESPERANDO_DIA\":\n    const diasInput = $json.messageText.trim();\n    \n    // Obtener d√≠as din√°micos de la sesi√≥n\n    let diasObj = {};\n    try {\n      const userSessionFromJSONBin = $('Read JSONBin').first().json.record[userSession.chatId];\n      if (userSessionFromJSONBin && userSessionFromJSONBin.maestrosDinamicos && userSessionFromJSONBin.maestrosDinamicos.dias) {\n        diasObj = userSessionFromJSONBin.maestrosDinamicos.dias;\n        console.log('=== USING DYNAMIC DIAS ===');\n        console.log('Dynamic dias:', JSON.stringify(diasObj, null, 2));\n        console.log('==========================');\n      } else {\n        // Fallback a datos est√°ticos si no hay din√°micos\n        diasObj = maestros.dias || {};\n        console.log('=== FALLBACK TO STATIC DIAS ===');\n        console.log('Static dias:', JSON.stringify(diasObj, null, 2));\n        console.log('===============================');\n      }\n    } catch (error) {\n      console.log('Error getting dynamic dias, using fallback:', error.message);\n      diasObj = maestros.dias || {};\n    }\n    \n    const diasResult = parseMultipleSelection(diasInput, diasObj);\n    \n    if (!diasResult.valid || diasResult.selections.length === 0) {\n      isValid = false;\n      let opciones = Object.keys(diasObj).map(key => `${key}. ${diasObj[key]}`).join('\\n');\n      let errorMsg = `‚ùå *No se reconoce el valor ingresado*\\n\\nOpciones v√°lidas:\\n${opciones}\\n\\n`;\n      if (diasResult.invalidItems.length > 0) {\n        errorMsg += `Valores inv√°lidos: ${diasResult.invalidItems.join(', ')}\\n`;\n      }\n      errorMsg += \"üí° Puede seleccionar m√∫ltiples opciones separ√°ndolas con comas\\nEjemplo: 1,3,5\";\n      errorMessage = errorMsg;\n    } else {\n      updateData.dias = diasResult.selections;\n      \n      console.log('=== DIAS SELECTION DEBUG ===');\n      console.log('Input:', diasInput);\n      console.log('Parsed result:', JSON.stringify(diasResult, null, 2));\n      console.log('Stored in updateData.dias:', JSON.stringify(updateData.dias, null, 2));\n      console.log('============================');\n      \n      // Obtener rangos horarios din√°micos de la sesi√≥n\n      let horariosObj = {};\n      try {\n        const userSessionFromJSONBin = $('Read JSONBin').first().json.record[userSession.chatId];\n        if (userSessionFromJSONBin && userSessionFromJSONBin.maestrosDinamicos && userSessionFromJSONBin.maestrosDinamicos.rangosHorarios) {\n          horariosObj = userSessionFromJSONBin.maestrosDinamicos.rangosHorarios;\n          console.log('=== USING DYNAMIC RANGOS HORARIOS ===');\n          console.log('Dynamic rangos horarios:', JSON.stringify(horariosObj, null, 2));\n          console.log('====================================');\n        } else {\n          // Fallback a datos est√°ticos si no hay din√°micos\n          horariosObj = maestros.rangosHorarios || {};\n          console.log('=== FALLBACK TO STATIC RANGOS HORARIOS ===');\n          console.log('Static rangos horarios:', JSON.stringify(horariosObj, null, 2));\n          console.log('==========================================');\n        }\n      } catch (error) {\n        console.log('Error getting dynamic rangos horarios, using fallback:', error.message);\n        horariosObj = maestros.rangosHorarios || {};\n      }\n      \n      let horariosText = \"üïê *Seleccione uno o m√°s rangos de horario:*\\n\\n\";\n      Object.keys(horariosObj).forEach(key => {\n        horariosText += `${key}. ${horariosObj[key]}\\n`;\n      });\n      horariosText += \"\\nüí° *Puede seleccionar m√∫ltiples opciones separ√°ndolas con comas*\\n\";\n      horariosText += \"Ejemplo: 1,2,4\";\n      \n      response = {\n        message: horariosText,\n        nextStep: \"ESPERANDO_HORARIO\"\n      };\n      newEstado = \"ESPERANDO_HORARIO\";\n    }\n    break;\n\n  case \"ESPERANDO_HORARIO\":\n    const horariosInput = $json.messageText.trim();\n    \n    // Obtener rangos horarios din√°micos de la sesi√≥n\n    let horariosObj = {};\n    try {\n      const userSessionFromJSONBin = $('Read JSONBin').first().json.record[userSession.chatId];\n      if (userSessionFromJSONBin && userSessionFromJSONBin.maestrosDinamicos && userSessionFromJSONBin.maestrosDinamicos.rangosHorarios) {\n        horariosObj = userSessionFromJSONBin.maestrosDinamicos.rangosHorarios;\n        console.log('=== USING DYNAMIC RANGOS HORARIOS (HORARIO SELECTION) ===');\n        console.log('Dynamic rangos horarios:', JSON.stringify(horariosObj, null, 2));\n        console.log('========================================================');\n      } else {\n        // Fallback a datos est√°ticos si no hay din√°micos\n        horariosObj = maestros.rangosHorarios || {};\n        console.log('=== FALLBACK TO STATIC RANGOS HORARIOS (HORARIO SELECTION) ===');\n        console.log('Static rangos horarios:', JSON.stringify(horariosObj, null, 2));\n        console.log('==============================================================');\n      }\n    } catch (error) {\n      console.log('Error getting dynamic rangos horarios for selection, using fallback:', error.message);\n      horariosObj = maestros.rangosHorarios || {};\n    }\n    \n    const horariosResult = parseMultipleSelection(horariosInput, horariosObj);\n    \n    if (!horariosResult.valid || horariosResult.selections.length === 0) {\n      isValid = false;\n      let opciones = Object.keys(horariosObj).map(key => `${key}. ${horariosObj[key]}`).join('\\n');\n      let errorMsg = `‚ùå *No se reconoce el valor ingresado*\\n\\nOpciones v√°lidas:\\n${opciones}\\n\\n`;\n      if (horariosResult.invalidItems.length > 0) {\n        errorMsg += `Valores inv√°lidos: ${horariosResult.invalidItems.join(', ')}\\n`;\n      }\n      errorMsg += \"üí° Puede seleccionar m√∫ltiples opciones separ√°ndolas con comas\\nEjemplo: 1,2,4\";\n      errorMessage = errorMsg;\n    } else {\n      updateData.horarios = horariosResult.selections;\n      \n      console.log('=== HORARIOS SELECTION DEBUG ===');\n      console.log('Input:', horariosInput);\n      console.log('Parsed result:', JSON.stringify(horariosResult, null, 2));\n      console.log('Stored in updateData.horarios:', JSON.stringify(updateData.horarios, null, 2));\n      console.log('================================');\n      \n      // Mostrar resumen y confirmaci√≥n con m√∫ltiples selecciones\n      const diasSeleccionados = updateData.dias.map(d => d.value).join(', ');\n      const horariosSeleccionados = updateData.horarios.map(h => h.value).join(', ');\n      \n      const resumen = `üìã *Resumen del Turno:*\\n\\n` +\n                     `üë§ DNI: ${updateData.dni}\\n` +\n                     `üë®‚Äç‚öïÔ∏è Especialidad: ${updateData.especialidad.descripcion}\\n` +\n                     `üìÖ D√≠as: ${diasSeleccionados}\\n` +\n                     `üïê Horarios: ${horariosSeleccionados}\\n\\n` +\n                     `*¬øConfirma el turno?*\\n\\n` +\n                     `1. ‚úÖ Aceptar\\n` +\n                     `2. ‚ùå Cancelar`;\n      \n      response = {\n        message: resumen,\n        nextStep: \"CONFIRMACION\"\n      };\n      newEstado = \"CONFIRMACION\";\n    }\n    break;\n\n  case \"CONFIRMACION\":\n    const confirmacion = parseInt($json.messageText.trim());\n    \n    if (confirmacion === 1) {\n      // Aceptar - preparar para env√≠o a API\n      response = {\n        message: \"‚úÖ *Turno confirmado*\\n\\nProcesando su solicitud...\",\n        nextStep: \"COMPLETADO\",\n        sendToAPI: true\n      };\n      newEstado = \"COMPLETADO\";\n    } else if (confirmacion === 2) {\n      // Cancelar - reiniciar proceso\n      updateData = {};\n      response = {\n        message: \"‚ùå *Turno cancelado*\\n\\n¬øDesea agendar un nuevo turno?\\n\\nEnv√≠e cualquier mensaje para comenzar.\",\n        nextStep: \"INICIO\"\n      };\n      newEstado = \"INICIO\";\n    } else {\n      isValid = false;\n      errorMessage = \"‚ùå *No se reconoce el valor ingresado*\\n\\nOpciones v√°lidas:\\n1. ‚úÖ Aceptar\\n2. ‚ùå Cancelar\";\n    }\n    break;\n\n  default:\n    // Estado desconocido, reiniciar\n    console.log('=== ESTADO DESCONOCIDO - REINICIANDO ===');\n    console.log('Estado actual:', userSession.estado);\n    console.log('======================================');\n    \n    response = {\n      message: \"üè• *Bienvenido al Sistema de Turnos*\\n\\nPor favor, indique su DNI (solo n√∫meros, sin puntos):\",\n      nextStep: \"ESPERANDO_DNI\"\n    };\n    newEstado = \"ESPERANDO_DNI\";\n    updateData = {};\n}\n\n// APLICAR LIMPIEZA DE CARACTERES (CORREGIDA)\nlet finalMessage = isValid ? response.message : errorMessage;\n\n// Limpiar caracteres especiales para WAAPI pero mantener saltos de l√≠nea\nlet cleanedResponse = finalMessage\n  // Quitamos los encabezados #\n  .replace(/^#+\\s+(.+)$/gm, \"$1\")\n  // Quitamos asteriscos de negrita\n  .replace(/\\*\\*([^*]+)\\*\\*/g, \"$1\")\n  // Simplificamos listados\n  .replace(/^\\s*-\\s+/gm, \"- \");\n\n// NO aplicar JSON.stringify para mantener los saltos de l√≠nea\n// cleanedResponse = JSON.stringify(cleanedResponse).slice(1, -1);\n\n// Resultado final\nreturn {\n  json: {\n    chatId: chatId,\n    isValid: isValid,\n    response: {\n      message: cleanedResponse, // Mensaje limpio para WAAPI\n      sendToAPI: response.sendToAPI || false\n    },\n    newEstado: isValid ? newEstado : userSession.estado,\n    updateData: isValid ? updateData : userSession.datos,\n    sendToAPI: response.sendToAPI || false,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2600,
        100
      ],
      "id": "601f1b82-057c-4281-8026-0a3704b79766",
      "name": "Process Step Logic"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salmasalud.com.ar/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"user\": \"admin\",\n  \"password\": \"1234\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2860,
        -120
      ],
      "id": "feafd4c9-dc9c-4342-bee4-122066413c73",
      "name": "Get Maestros Token"
    },
    {
      "parameters": {
        "url": "https://api.salmasalud.com.ar/especialidades",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.token }}"
            },
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2540,
        -120
      ],
      "id": "cd3c0a45-880b-423e-85c5-c8eb50799997",
      "name": "Get Especialidades"
    },
    {
      "parameters": {
        "jsCode": "// Nodo: Format Maestros Data\n// CORREGIDO: Usar $input.all (sin par√©ntesis) para obtener TODAS las especialidades\nconst allInputs = $input.all()\nlet especialidades = [];\n\nconsole.log('=== ESPECIALIDADES FROM API (CORREGIDO) ===');\nconsole.log('Total inputs received:', allInputs.length);\nconsole.log('All inputs:', JSON.stringify(allInputs, null, 2));\n\n// Extraer todas las especialidades de todos los inputs\nfor (const input of allInputs) {\n  if (Array.isArray(input.json)) {\n    // Si el input.json es un array, agregamos todos los elementos\n    especialidades = especialidades.concat(input.json);\n    console.log('Added array of especialidades:', input.json.length, 'items');\n  } else if (input.json && typeof input.json === 'object') {\n    // Si es un objeto individual, lo agregamos como item √∫nico\n    especialidades.push(input.json);\n    console.log('Added single especialidad:', input.json.descripcion || input.json);\n  }\n}\n\nconsole.log('=======================================');\n\n// Formatear especialidades para mantener compatibilidad con el c√≥digo existente\nconst maestrosData = {\n  especialidades: especialidades\n};\n\nconsole.log('=== MAESTROS FORMATTED (CORREGIDO) ===');\nconsole.log('Total especialidades processed:', especialidades.length);\nconsole.log('Final maestros data:', JSON.stringify(maestrosData, null, 2));\nconsole.log('=====================================');\n\nreturn {\n  json: maestrosData\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2220,
        -80
      ],
      "id": "1ff9cb2b-3888-4b68-b455-f43e1e875b75",
      "name": "Format Maestros"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Update User Session (CORREGIDO PARA JSONBIN)\nconst processData = $json;\nconst chatId = processData.chatId;\nconst newEstado = processData.newEstado;\nconst updateData = processData.updateData;\n\n// Obtener las sesiones actuales desde JSONBin\nlet allSessions = {};\ntry {\n  const jsonbinData = $('Read JSONBin').first().json;\n  if (jsonbinData && jsonbinData.record) {\n    allSessions = { ...jsonbinData.record };\n  }\n  console.log('=== UPDATE USER SESSION ===');\n  console.log('ChatId a actualizar:', chatId);\n  console.log('Nuevo estado:', newEstado);\n  console.log('Datos a actualizar:', JSON.stringify(updateData, null, 2));\n  console.log('Sesiones existentes:', Object.keys(allSessions).length);\n} catch (error) {\n  console.error('Error obteniendo sesiones de JSONBin:', error);\n}\n\n// Actualizar o crear la sesi√≥n del usuario\nallSessions[chatId] = {\n  chatId: chatId,\n  estado: newEstado,\n  datos: updateData,\n  createdAt: allSessions[chatId]?.createdAt || new Date().toISOString(),\n  lastActivity: new Date().toISOString(),\n  updatedAt: new Date().toISOString()\n};\n\nconsole.log('=== SESI√ìN ACTUALIZADA ===');\nconsole.log('Sesi√≥n del usuario:', JSON.stringify(allSessions[chatId], null, 2));\nconsole.log('Total sesiones despu√©s de actualizar:', Object.keys(allSessions).length);\nconsole.log('============================');\n\n// Preparar estructura para JSONBin\nconst jsonbinPayload = {\n  sessions: allSessions\n};\n\nreturn {\n  json: jsonbinPayload\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2340,
        60
      ],
      "id": "145840de-e1a4-484e-8a5e-a82ee52d8e31",
      "name": "Update User Session"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Prepare API Request (CON VALIDACI√ìN MEJORADA)\nconst processStepData = $('Process Step Logic').first().json;\nconst jsonbinData = $json;\n\nconsole.log('=== PREPARE API REQUEST DEBUG ===');\nconsole.log('Process Step Data:', JSON.stringify(processStepData, null, 2));\nconsole.log('JSONBin Data keys:', Object.keys(jsonbinData));\nconsole.log('Send to API from Process Step:', processStepData.sendToAPI);\nconsole.log('================================');\n\n// VALIDACI√ìN PRINCIPAL: Verificar si debe enviar a API desde Process Step Logic\nif (!processStepData.sendToAPI) {\n  console.log('‚ùå SKIPPING API - Process Step Logic says sendToAPI = false');\n  return {\n    json: {\n      skipAPI: true,\n      reason: \"Process Step Logic indicates no API call needed\",\n      processStepData: processStepData\n    }\n  };\n}\n\n// Obtener datos de la sesi√≥n actualizada\nlet userSession = null;\nlet sendToAPI = false;\n\ntry {\n  // Los datos vienen en record desde JSONBin\n  if (jsonbinData.record) {\n    const sessions = jsonbinData.record;\n    \n    // Buscar la sesi√≥n que coincida con el chatId del Process Step Logic\n    const targetChatId = processStepData.chatId;\n    \n    if (sessions[targetChatId]) {\n      userSession = sessions[targetChatId];\n      \n      // VALIDACI√ìN CR√çTICA: Solo enviar a API si est√° en estado COMPLETADO Y Process Step Logic lo confirma\n      if (userSession.estado === \"COMPLETADO\" && processStepData.sendToAPI === true) {\n        sendToAPI = true;\n      }\n    }\n  }\n  \n  console.log('=== SESSION VALIDATION ===');\n  console.log('Target ChatId:', processStepData.chatId);\n  console.log('User session found:', !!userSession);\n  console.log('User session state:', userSession?.estado);\n  console.log('Send to API decision:', sendToAPI);\n  console.log('========================');\n  \n} catch (error) {\n  console.error('Error extrayendo datos de JSONBin:', error);\n  return {\n    json: {\n      skipAPI: true,\n      error: \"Error extrayendo datos de JSONBin: \" + error.message\n    }\n  };\n}\n\n// Verificar si debe enviar a API\nif (!sendToAPI || !userSession || !userSession.datos || !userSession.datos.dni) {\n  console.log('‚ùå SKIPPING API - Validation failed');\n  console.log('sendToAPI:', sendToAPI);\n  console.log('userSession exists:', !!userSession);\n  console.log('userSession.datos exists:', !!userSession?.datos);\n  console.log('DNI exists:', !!userSession?.datos?.dni);\n  \n  return {\n    json: {\n      skipAPI: true,\n      message: \"No se requiere env√≠o a API - validaci√≥n fallida\",\n      debugInfo: {\n        sendToAPI,\n        hasUserSession: !!userSession,\n        hasUserData: !!userSession?.datos,\n        hasDNI: !!userSession?.datos?.dni,\n        userState: userSession?.estado\n      }\n    }\n  };\n}\n\n// Preparar arrays de d√≠as y horarios desde las selecciones m√∫ltiples\nlet diasArray = [];\nlet horariosArray = [];\n\nconsole.log('=== DEBUGGING SELECTION DATA ===');\nconsole.log('userSession.datos:', JSON.stringify(userSession.datos, null, 2));\nconsole.log('dias exists:', !!userSession.datos.dias);\nconsole.log('horarios exists:', !!userSession.datos.horarios);\n\n// Extraer d√≠as seleccionados con validaci√≥n robusta\nif (userSession.datos.dias && Array.isArray(userSession.datos.dias)) {\n  console.log('Processing multiple dias:', userSession.datos.dias);\n  diasArray = userSession.datos.dias\n    .filter(dia => dia && dia.id !== undefined && dia.id !== null)\n    .map(dia => parseInt(dia.id));\n} else if (userSession.datos.dia && userSession.datos.dia.id) {\n  // Compatibilidad con versi√≥n anterior (selecci√≥n √∫nica)\n  console.log('Processing single dia:', userSession.datos.dia);\n  diasArray = [parseInt(userSession.datos.dia.id)];\n}\n\n// Extraer horarios seleccionados con validaci√≥n robusta\nif (userSession.datos.horarios && Array.isArray(userSession.datos.horarios)) {\n  console.log('Processing multiple horarios:', userSession.datos.horarios);\n  horariosArray = userSession.datos.horarios\n    .filter(horario => horario && horario.id !== undefined && horario.id !== null)\n    .map(horario => parseInt(horario.id));\n} else if (userSession.datos.horario && userSession.datos.horario.id) {\n  // Compatibilidad con versi√≥n anterior (selecci√≥n √∫nica)\n  console.log('Processing single horario:', userSession.datos.horario);\n  horariosArray = [parseInt(userSession.datos.horario.id)];\n}\n\nconsole.log('Final diasArray:', diasArray);\nconsole.log('Final horariosArray:', horariosArray);\nconsole.log('===============================');\n\n// Preparar datos para API seg√∫n formato requerido\nconst apiData = {\n  documento: userSession.datos.dni,\n  telefono: userSession.chatId.split('@')[0],\n  idEspecialidad: userSession.datos.especialidad.idEspecialidad,\n  dias: diasArray,\n  rangosHorarios: horariosArray\n};\n\nconsole.log('=== API DATA PREPARED (VALIDATED) ===');\nconsole.log('D√≠as seleccionados:', diasArray);\nconsole.log('Horarios seleccionados:', horariosArray);\nconsole.log('API Data:', JSON.stringify(apiData, null, 2));\nconsole.log('====================================');\n\n// Validar que tenemos al menos una selecci√≥n de cada\nif (diasArray.length === 0 || horariosArray.length === 0) {\n  console.error('‚ùå Error: No hay d√≠as u horarios seleccionados');\n  return {\n    json: {\n      skipAPI: true,\n      error: \"Error: Faltan d√≠as u horarios seleccionados\"\n    }\n  };\n}\n\nreturn {\n  json: {\n    skipAPI: false,\n    apiData: apiData,\n    chatId: userSession.chatId,\n    userSession: userSession,\n    selectionSummary: {\n      diasCount: diasArray.length,\n      horariosCount: horariosArray.length,\n      totalCombinations: diasArray.length * horariosArray.length\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1700,
        140
      ],
      "id": "8b0b7ffe-5da3-4fa0-8d09-c290a618aa89",
      "name": "Prepare API Request"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Format Final Response (CORREGIDO PARA SELECCI√ìN M√öLTIPLE)\nconst skipAPI = $json.skipAPI || false;\nlet finalMessage = \"\";\nlet chatId = \"\";\n\n// Obtener chatId del flujo\ntry {\n  chatId = $('menssageIn').first().json.chatId || $('Get User Session').first().json.chatId;\n} catch {\n  chatId = \"unknown\";\n}\n\nif (skipAPI) {\n  // Si no se envi√≥ a API, obtener el mensaje del Process Step Logic\n  try {\n    const stepLogicResponse = $('Process Step Logic').first().json.response;\n    finalMessage = stepLogicResponse ? stepLogicResponse.message : \"Mensaje procesado correctamente\";\n  } catch {\n    finalMessage = \"Error al obtener respuesta del flujo\";\n  }\n} else {\n  // Respuesta de la API\n  const apiResponse = $json;\n  let userSession = null;\n  \n  // Obtener sesi√≥n de usuario\n  try {\n    userSession = $('Prepare API Request').first().json.userSession;\n  } catch {\n    userSession = null;\n  }\n  \n  console.log('=== FORMAT FINAL RESPONSE ===');\n  console.log('API Response:', JSON.stringify(apiResponse, null, 2));\n  console.log('User Session:', userSession ? 'Found' : 'Not found');\n  if (userSession) {\n    console.log('User Session Data:', JSON.stringify(userSession.datos, null, 2));\n  }\n  console.log('============================');\n  \n  // NUEVA CONDICI√ìN: La API devuelve un array con el ID del turno\n  if (apiResponse && (typeof apiResponse === 'number' || typeof apiResponse === 'string')) {\n    const turnoId = apiResponse;\n    \n    if (userSession && userSession.datos) {\n      // Construir mensaje con selecciones m√∫ltiples\n      let diasText = 'N/A';\n      let horariosText = 'N/A';\n      \n      // Manejar d√≠as (m√∫ltiples o √∫nico)\n      if (userSession.datos.dias && Array.isArray(userSession.datos.dias)) {\n        diasText = userSession.datos.dias.map(d => d.value).join(', ');\n      } else if (userSession.datos.dia && userSession.datos.dia.nombre) {\n        diasText = userSession.datos.dia.nombre;\n      }\n      \n      // Manejar horarios (m√∫ltiples o √∫nico)\n      if (userSession.datos.horarios && Array.isArray(userSession.datos.horarios)) {\n        horariosText = userSession.datos.horarios.map(h => h.value).join(', ');\n      } else if (userSession.datos.horario && userSession.datos.horario.rango) {\n        horariosText = userSession.datos.horario.rango;\n      }\n      \n      finalMessage = `‚úÖ ¬°Turno agendado exitosamente!\\\\n\\\\n` +\n                     `üé´ N√∫mero de turno: ${turnoId}\\\\n` +\n                     `üë§ DNI: ${userSession.datos.dni}\\\\n` +\n                     `üìû Tel√©fono: ${userSession.chatId.split('@')[0]}\\\\n` +\n                     `üë®‚Äç‚öïÔ∏è Especialidad: ${userSession.datos.especialidad ? userSession.datos.especialidad.descripcion : 'N/A'}\\\\n` +\n                     `üìÖ D√≠as: ${diasText}\\\\n` +\n                     `üïê Horarios: ${horariosText}\\\\n\\\\n` +\n                     `üì± Guarde este n√∫mero de turno para futuras consultas.\\\\n\\\\n` +\n                     `¬°Gracias por usar nuestro sistema!`;\n    } else {\n      finalMessage = `‚úÖ ¬°Turno agendado exitosamente!\\\\n\\\\nüé´ N√∫mero de turno: ${turnoId}`;\n    }\n  } else {\n    // Si no es un ID v√°lido, es un error\n    finalMessage = `‚ùå Error al agendar el turno\\\\n\\\\n` +\n                   `Lo sentimos, hubo un problema al procesar su solicitud.\\\\n` +\n                   `Por favor intente nuevamente m√°s tarde.\\\\n\\\\n` +\n                   `Error: ${typeof apiResponse === 'string' ? apiResponse : JSON.stringify(apiResponse) || 'Error desconocido'}`;\n  }\n}\n\n// APLICAR LIMPIEZA DE CARACTERES\nlet cleanedMessage = finalMessage\n  .replace(/^#+\\\\s+(.+)$/gm, \"$1\")\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");\n\ncleanedMessage = JSON.stringify(cleanedMessage).slice(1, -1);\n\nreturn {\n  json: {\n    chatId: chatId,\n    message: cleanedMessage,\n    messageType: \"text\"\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1780,
        480
      ],
      "id": "7407e258-c9cc-4507-8339-e5ae9745e927",
      "name": "Format Final Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salmasalud.com.ar/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"user\": \"admin\",\n  \"password\": \"1234\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2400,
        340
      ],
      "id": "578a9d27-c816-43d5-8b83-3bab4d884f97",
      "name": "Get Token"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salmasalud.com.ar/solicitar",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Prepare API Request').first().json.apiData }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2100,
        340
      ],
      "id": "ffa4e8df-721f-4bdd-adc4-eb34adb94dd8",
      "name": "Send to API"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://waapi.app/api/v1/instances/76556/client/action/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer RnfskkYrbR0Sh2Acnr5B9GwPDl545m1jPPKDbccoa2ab2e89"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chatId\": \"{{ $json.chatId }}\",\n  \"message\": \"{{ $json.message }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1400,
        420
      ],
      "id": "080d2e47-963e-4819-bddf-741068f56158",
      "name": "Send WhatsApp Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://waapi.app/api/v1/instances/76556/client/action/send-typing",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer RnfskkYrbR0Sh2Acnr5B9GwPDl545m1jPPKDbccoa2ab2e89"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chatId\": \"{{ $json.body.data.message.from }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3300,
        0
      ],
      "id": "081d9c06-c747-41cb-b3b4-f89db4e52c8a",
      "name": "send-typing"
    },
    {
      "parameters": {
        "url": "https://api.jsonbin.io/v3/b/687566205d646f1c273fa03e/latest",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Master-Key",
              "value": "$2a$10$x6g.oxG8TSRAhrOyGXNhjOcipTIiu9RU3X/h2S0DC4kbIalK9KxEO"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3020,
        220
      ],
      "id": "65604f7e-30dc-4457-9d96-870755cea2f2",
      "name": "Read JSONBin"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "https://api.jsonbin.io/v3/b/687566205d646f1c273fa03e",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Master-Key",
              "value": "$2a$10$x6g.oxG8TSRAhrOyGXNhjOcipTIiu9RU3X/h2S0DC4kbIalK9KxEO"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.sessions }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2080,
        40
      ],
      "id": "e3f1d719-b353-4b40-a6ce-e99edaebd298",
      "name": "Write JSONBin"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "232f6117-6d57-40c2-a834-115089cb6dca",
              "leftValue": "={{ $json.skipAPI }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2680,
        520
      ],
      "id": "e36e5a2a-0458-4aff-b98c-331b0e5b5046",
      "name": "API Decision"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "dni-validation-condition-simple",
              "leftValue": "={{ $('Get User Session').first().json.userSession.estado === 'ESPERANDO_DNI' && $json.newEstado === 'ESPERANDO_ESPECIALIDAD' && $json.isValid === true && $json.updateData.dni }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2560,
        -140
      ],
      "id": "96a74cf6-7f38-4004-8a52-1f2724df90de",
      "name": "DNI Validation Decision"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Update Session - DNI Validation\nconst processData = $json;\nconst chatId = processData.chatId;\nlet newEstado = processData.newEstado;\nlet updateData = processData.updateData;\n\n// Determinar fuente de datos - puede venir de Process Step Logic o Process DNI Validation\nlet sourceNode = null;\ntry {\n  // Intentar obtener datos de Process DNI Validation primero\n  const dniValidationData = $('Process DNI Validation').first();\n  if (dniValidationData && dniValidationData.json) {\n    sourceNode = 'Process DNI Validation';\n    newEstado = dniValidationData.json.newEstado;\n    updateData = dniValidationData.json.updateData;\n    chatId = dniValidationData.json.chatId;\n    console.log('üìã Usando datos de Process DNI Validation');\n  }\n} catch (error) {\n  console.log('‚ùå No se encontraron datos de Process DNI Validation:', error.message);\n}\n\n// Si no hay datos de validaci√≥n DNI, usar Process Step Logic\nif (!sourceNode) {\n  sourceNode = 'Process Step Logic';\n  console.log('üìã Usando datos de Process Step Logic');\n}\n\n// Obtener las sesiones actuales desde JSONBin\nlet allSessions = {};\ntry {\n  const jsonbinData = $('Read JSONBin').first().json;\n  if (jsonbinData && jsonbinData.record) {\n    allSessions = { ...jsonbinData.record };\n  }\n  console.log('=== UPDATE USER SESSION (DNI VALIDATION) ===');\n  console.log('Fuente de datos:', sourceNode);\n  console.log('ChatId a actualizar:', chatId);\n  console.log('Nuevo estado:', newEstado);\n  console.log('Datos a actualizar:', JSON.stringify(updateData, null, 2));\n  console.log('Sesiones existentes:', Object.keys(allSessions).length);\n} catch (error) {\n  console.error('Error obteniendo sesiones de JSONBin:', error);\n}\n\n// Actualizar o crear la sesi√≥n del usuario\nallSessions[chatId] = {\n  chatId: chatId,\n  estado: newEstado,\n  datos: updateData,\n  createdAt: allSessions[chatId]?.createdAt || new Date().toISOString(),\n  lastActivity: new Date().toISOString(),\n  updatedAt: new Date().toISOString()\n};\n\nconsole.log('=== SESI√ìN ACTUALIZADA (DNI VALIDATION) ===');\nconsole.log('Sesi√≥n del usuario:', JSON.stringify(allSessions[chatId], null, 2));\nconsole.log('Total sesiones despu√©s de actualizar:', Object.keys(allSessions).length);\nconsole.log('============================================');\n\n// Preparar estructura para JSONBin\nconst jsonbinPayload = {\n  sessions: allSessions\n};\n\nreturn {\n  json: jsonbinPayload\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1640,
        20
      ],
      "id": "9ab917c9-2134-4427-9991-097778a7abf2",
      "name": "Update Session - DNI Validation"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "https://api.jsonbin.io/v3/b/687566205d646f1c273fa03e",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Master-Key",
              "value": "$2a$10$x6g.oxG8TSRAhrOyGXNhjOcipTIiu9RU3X/h2S0DC4kbIalK9KxEO"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.sessions }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1400,
        20
      ],
      "id": "c09988ea-9de1-4532-b519-2d1a4178f30d",
      "name": "Write JSONBin 2"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Format DNI Validation Response\nlet finalMessage = \"\";\nlet chatId = \"\";\n\n// Obtener datos de la validaci√≥n del DNI\ntry {\n  const dniValidationData = $('Process DNI Validation').first().json;\n  chatId = dniValidationData.chatId;\n  finalMessage = dniValidationData.response.message;\n  \n  console.log('=== FORMAT DNI VALIDATION RESPONSE ===');\n  console.log('ChatId:', chatId);\n  console.log('Message:', finalMessage);\n  console.log('Continue Flow:', dniValidationData.continueFlow);\n  console.log('=====================================');\n  \n} catch (error) {\n  console.error('Error obteniendo datos de DNI Validation:', error);\n  chatId = \"unknown\";\n  finalMessage = \"Error procesando validaci√≥n de DNI\";\n}\n\n// APLICAR LIMPIEZA DE CARACTERES\nlet cleanedMessage = finalMessage\n  .replace(/^#+\\\\s+(.+)$/gm, \"$1\")\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");\n\ncleanedMessage = JSON.stringify(cleanedMessage).slice(1, -1);\n\nreturn {\n  json: {\n    chatId: chatId,\n    message: cleanedMessage,\n    messageType: \"text\"\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1160,
        20
      ],
      "id": "c24e1036-a583-4337-a321-79ab565ea054",
      "name": "Format DNI Validation Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salmasalud.com.ar/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"user\": \"admin\",\n  \"password\": \"1234\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1840,
        -280
      ],
      "id": "b5f9b2cb-b9bf-44be-b461-b9b81e722051",
      "name": "DNI Validation - Get Token"
    },
    {
      "parameters": {
        "url": "=https://api.salmasalud.com.ar/paciente-by-documento/{{ $('Process Step Logic').first().json.updateData.dni }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1880,
        -100
      ],
      "id": "a39a86ea-cabe-413d-8917-4e201467ab46",
      "name": "DNI Validation Request"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Process DNI Validation Response\nconst dniValidationResponse = $json;\nconst processStepData = $('Process Step Logic').first().json;\nconst maestros = $('Format Maestros').first().json;\n\n// Obtener DNI desde m√∫ltiples fuentes para mayor robustez\nlet dni = processStepData.updateData?.dni;\nif (!dni) {\n  const getUserSessionData = $('Get User Session').first().json;\n  dni = getUserSessionData.messageText?.replace(/[^0-9]/g, '');\n}\n\nconsole.log('=== DNI VALIDATION RESPONSE ===');\nconsole.log('DNI being validated:', dni);\nconsole.log('API Response:', JSON.stringify(dniValidationResponse, null, 2));\nconsole.log('Process Step Data:', JSON.stringify(processStepData, null, 2));\nconsole.log('==============================');\n\nlet continueFlow = false;\nlet responseMessage = \"\";\nlet newEstado = processStepData.newEstado;\nlet pacienteInfo = null;\n\n// Verificar si el DNI fue encontrado en la API\nif (dniValidationResponse && (dniValidationResponse.id || dniValidationResponse.idPaciente)) {\n  // Paciente encontrado\n  pacienteInfo = dniValidationResponse;\n  continueFlow = true;\n  \n  console.log('‚úÖ PACIENTE ENCONTRADO:', {\n    id: pacienteInfo.id || pacienteInfo.idPaciente,\n    nombre: pacienteInfo.nombre,\n    apellido: pacienteInfo.apellido,\n    dni: dni\n  });\n  \n  // Obtener especialidades del maestro\n  const especialidades = maestros.especialidades;\n  \n  let nombreCompleto = [pacienteInfo.nombre, pacienteInfo.apellido].filter(Boolean).join(' ');\n  let especialidadesText = `üëã ¬°Hola ${nombreCompleto}!\\n\\nüë®‚Äç‚öïÔ∏è *Seleccione una especialidad:*\\n\\n`;\n  especialidades.forEach(esp => {\n    especialidadesText += `${esp.idEspecialidad}. ${esp.descripcion}\\n`;\n  });\n  \n  responseMessage = especialidadesText;\n  newEstado = \"ESPERANDO_ESPECIALIDAD\";\n  \n} else {\n  // Paciente no encontrado\n  continueFlow = false;\n  \n  console.log('‚ùå PACIENTE NO ENCONTRADO para DNI:', dni);\n  console.log('API Response details:', {\n    hasResponse: !!dniValidationResponse,\n    responseKeys: dniValidationResponse ? Object.keys(dniValidationResponse) : [],\n    responseType: typeof dniValidationResponse\n  });\n  \n  responseMessage = `‚ùå *Paciente no encontrado*\\n\\n` +\n                   `No se encontr√≥ un paciente registrado con el DNI: ${dni}\\n\\n` +\n                   `Por favor verifique el n√∫mero de documento o consulte en recepci√≥n para registrarse.\\n\\n` +\n                   `Si necesita agendar un turno con otro DNI, env√≠e cualquier mensaje para comenzar nuevamente.`;\n  newEstado = \"INICIO\"; // Reiniciar el flujo\n}\n\n// APLICAR LIMPIEZA DE CARACTERES\nlet cleanedResponse = responseMessage\n  .replace(/^#+\\s+(.+)$/gm, \"$1\")\n  .replace(/\\*\\*([^*]+)\\*\\*/g, \"$1\")\n  .replace(/^\\s*-\\s+/gm, \"- \");\n\n// Asegurar que el DNI est√© en updateData para flujos posteriores\nlet finalUpdateData = continueFlow ? {\n  ...processStepData.updateData,\n  dni: dni, // Asegurar que el DNI est√© presente\n  pacienteInfo: pacienteInfo\n} : {}; // Limpiar datos si no se encuentra el paciente\n\nreturn {\n  json: {\n    chatId: processStepData.chatId,\n    continueFlow: continueFlow,\n    response: {\n      message: cleanedResponse,\n      sendToAPI: false\n    },\n    newEstado: newEstado,\n    updateData: finalUpdateData,\n    pacienteInfo: pacienteInfo,\n    isValid: true,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1640,
        -100
      ],
      "id": "3939ef90-7ffb-4b6e-859b-ebbc5162ce6a",
      "name": "Process DNI Validation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "especialidad-selection-condition",
              "leftValue": "={{ $('Get User Session').first().json.userSession.estado === 'ESPERANDO_ESPECIALIDAD' && $json.newEstado === 'ESPERANDO_DIA' && $json.isValid === true && $json.updateData.especialidad }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2420,
        -280
      ],
      "id": "0a43b436-ea3f-4e96-bfe4-492d9deadfec",
      "name": "Especialidad Selection Decision"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salmasalud.com.ar/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"user\": \"admin\",\n  \"password\": \"1234\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2080,
        -280
      ],
      "id": "deab4622-826b-4c4b-a069-b799e8a2f2ec",
      "name": "Get Dias Horarios Token"
    },
    {
      "parameters": {
        "url": "=https://api.salmasalud.com.ar/dias?idEspecialidad={{ $('Process Step Logic').first().json.updateData.especialidad.idEspecialidad }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.token }}"
            },
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1740,
        -280
      ],
      "id": "ac3322cf-f440-409b-b0e5-68516173c9f8",
      "name": "Get Dias"
    },
    {
      "parameters": {
        "url": "=https://api.salmasalud.com.ar/rangos-horarios?idEspecialidad={{ $('Get Dias Horarios Token').first().json.token && $('Process Step Logic').first().json.updateData.especialidad.idEspecialidad }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Get Dias Horarios Token').first().json.token }}"
            },
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1400,
        -280
      ],
      "id": "8a1b9262-8467-49d0-934f-9b292b9a9a96",
      "name": "Get Rangos Horarios"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Process Dynamic Maestros\nconst especialidades = $('Format Maestros').first().json.especialidades;\nconst dias = $('Get Dias').first().json;\nconst rangosHorarios = $('Get Rangos Horarios').first().json;\nconst processStepData = $('Process Step Logic').first().json;\n\nconsole.log('=== PROCESS DYNAMIC MAESTROS ===');\nconsole.log('Especialidades:', JSON.stringify(especialidades, null, 2));\nconsole.log('Dias from API:', JSON.stringify(dias, null, 2));\nconsole.log('Rangos Horarios from API:', JSON.stringify(rangosHorarios, null, 2));\nconsole.log('Process Step Data:', JSON.stringify(processStepData, null, 2));\nconsole.log('===============================');\n\n// Convertir d√≠as de array a objeto con formato esperado\nlet diasObj = {};\nif (Array.isArray(dias)) {\n  dias.forEach((dia, index) => {\n    // CORREGIDO: Usar idTipoDia como ID y descripcion como valor\n    const diaId = dia.idTipoDia || (index + 1);\n    const diaDesc = dia.descripcion || `D√≠a ${index + 1}`;\n    diasObj[diaId] = diaDesc;\n  });\n} else if (typeof dias === 'object' && dias !== null) {\n  diasObj = dias;\n}\n\n// Convertir rangos horarios de array a objeto con formato esperado\nlet rangosHorariosObj = {};\nif (Array.isArray(rangosHorarios)) {\n  rangosHorarios.forEach((rango, index) => {\n    // CORREGIDO: Usar idRangoHorario como ID y descripcion como valor\n    const rangoId = rango.idRangoHorario || (index + 1);\n    const rangoDesc = rango.descripcion || `Horario ${index + 1}`;\n    rangosHorariosObj[rangoId] = rangoDesc;\n  });\n} else if (typeof rangosHorarios === 'object' && rangosHorarios !== null) {\n  rangosHorariosObj = rangosHorarios;\n}\n\nconsole.log('=== PROCESSED DYNAMIC DATA ===');\nconsole.log('Dias object:', JSON.stringify(diasObj, null, 2));\nconsole.log('Rangos Horarios object:', JSON.stringify(rangosHorariosObj, null, 2));\nconsole.log('==============================');\n\n// Crear el objeto maestros completo con datos din√°micos\nconst maestrosDinamicos = {\n  especialidades: especialidades,\n  dias: diasObj,\n  rangosHorarios: rangosHorariosObj\n};\n\n// Generar respuesta con d√≠as para el usuario\nlet diasText = \"üìÖ *Seleccione uno o m√°s d√≠as:*\\n\\n\";\nObject.keys(diasObj).forEach(key => {\n  diasText += `${key}. ${diasObj[key]}\\n`;\n});\ndiasText += \"\\nüí° *Puede seleccionar m√∫ltiples opciones separ√°ndolas con comas*\\n\";\ndiasText += \"Ejemplo: 1,3,5\";\n\n// APLICAR LIMPIEZA DE CARACTERES\nlet cleanedResponse = diasText\n  .replace(/^#+\\s+(.+)$/gm, \"$1\")\n  .replace(/\\*\\*([^*]+)\\*\\*/g, \"$1\")\n  .replace(/^\\s*-\\s+/gm, \"- \");\n\nreturn {\n  json: {\n    chatId: processStepData.chatId,\n    maestrosDinamicos: maestrosDinamicos,\n    response: {\n      message: cleanedResponse,\n      sendToAPI: false\n    },\n    newEstado: \"ESPERANDO_DIA\",\n    updateData: processStepData.updateData,\n    isValid: true,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1060,
        -280
      ],
      "id": "f058f244-99a0-4003-8e9c-3bbad076aeaa",
      "name": "Process Dynamic Maestros"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Update Session - Dynamic Maestros\nconst processData = $json;\nconst chatId = processData.chatId;\nconst newEstado = processData.newEstado;\nconst updateData = processData.updateData;\nconst maestrosDinamicos = processData.maestrosDinamicos;\n\n// Obtener las sesiones actuales desde JSONBin\nlet allSessions = {};\ntry {\n  const jsonbinData = $('Read JSONBin').first().json;\n  if (jsonbinData && jsonbinData.record) {\n    allSessions = { ...jsonbinData.record };\n  }\n  console.log('=== UPDATE SESSION - DYNAMIC MAESTROS ===');\n  console.log('ChatId a actualizar:', chatId);\n  console.log('Nuevo estado:', newEstado);\n  console.log('Datos a actualizar:', JSON.stringify(updateData, null, 2));\n  console.log('Maestros din√°micos:', JSON.stringify(maestrosDinamicos, null, 2));\n  console.log('========================================');\n} catch (error) {\n  console.error('Error obteniendo sesiones de JSONBin:', error);\n}\n\n// Actualizar la sesi√≥n del usuario\nallSessions[chatId] = {\n  chatId: chatId,\n  estado: newEstado,\n  datos: updateData,\n  maestrosDinamicos: maestrosDinamicos, // Guardar los maestros din√°micos en la sesi√≥n\n  createdAt: allSessions[chatId]?.createdAt || new Date().toISOString(),\n  lastActivity: new Date().toISOString(),\n  updatedAt: new Date().toISOString()\n};\n\nconsole.log('=== SESI√ìN ACTUALIZADA (DYNAMIC MAESTROS) ===');\nconsole.log('Sesi√≥n del usuario:', JSON.stringify(allSessions[chatId], null, 2));\nconsole.log('Total sesiones despu√©s de actualizar:', Object.keys(allSessions).length);\nconsole.log('=============================================');\n\n// Preparar estructura para JSONBin\nconst jsonbinPayload = {\n  sessions: allSessions\n};\n\nreturn {\n  json: jsonbinPayload\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        -280
      ],
      "id": "17f56ea2-d21e-40ce-8e8d-ebc9c11f6160",
      "name": "Update Session - Dynamic Maestros"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "https://api.jsonbin.io/v3/b/687566205d646f1c273fa03e",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Master-Key",
              "value": "$2a$10$x6g.oxG8TSRAhrOyGXNhjOcipTIiu9RU3X/h2S0DC4kbIalK9KxEO"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.sessions }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -380,
        -280
      ],
      "id": "bd534a2d-8ffc-4402-91ce-cede41d0be4a",
      "name": "Write JSONBin - Dynamic Maestros"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Nodo: Format Dynamic Maestros Response\nlet finalMessage = \"\";\nlet chatId = \"\";\n\n// Obtener datos del proceso din√°mico de maestros\ntry {\n  const dynamicMaestrosData = $('Process Dynamic Maestros').first().json;\n  chatId = dynamicMaestrosData.chatId;\n  finalMessage = dynamicMaestrosData.response.message;\n  \n  console.log('=== FORMAT DYNAMIC MAESTROS RESPONSE ===');\n  console.log('ChatId:', chatId);\n  console.log('Message:', finalMessage);\n  console.log('Maestros din√°micos agregados a la sesi√≥n');\n  console.log('=======================================');\n  \n} catch (error) {\n  console.error('Error obteniendo datos de Dynamic Maestros:', error);\n  chatId = \"unknown\";\n  finalMessage = \"Error procesando datos din√°micos\";\n}\n\n// APLICAR LIMPIEZA DE CARACTERES\nlet cleanedMessage = finalMessage\n  .replace(/^#+\\\\s+(.+)$/gm, \"$1\")\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");\n\ncleanedMessage = JSON.stringify(cleanedMessage).slice(1, -1);\n\nreturn {\n  json: {\n    chatId: chatId,\n    message: cleanedMessage,\n    messageType: \"text\"\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -40,
        -280
      ],
      "id": "4c5c7ace-9781-4a8e-8b0d-79b7d6ddb99d",
      "name": "Format Dynamic Maestros Response"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "menssageIn",
            "type": "main",
            "index": 0
          },
          {
            "node": "send-typing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "menssageIn": {
      "main": [
        [
          {
            "node": "Read JSONBin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Session": {
      "main": [
        [
          {
            "node": "Process Step Logic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Step Logic": {
      "main": [
        [
          {
            "node": "DNI Validation Decision",
            "type": "main",
            "index": 0
          },
          {
            "node": "Especialidad Selection Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DNI Validation Decision": {
      "main": [
        [
          {
            "node": "DNI Validation - Get Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update User Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User Session": {
      "main": [
        [
          {
            "node": "Write JSONBin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare API Request": {
      "main": [
        [
          {
            "node": "API Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Token": {
      "main": [
        [
          {
            "node": "Send to API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Final Response": {
      "main": [
        [
          {
            "node": "Send WhatsApp Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to API": {
      "main": [
        [
          {
            "node": "Format Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read JSONBin": {
      "main": [
        [
          {
            "node": "Get User Session",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Maestros Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write JSONBin": {
      "main": [
        [
          {
            "node": "Prepare API Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Decision": {
      "main": [
        [
          {
            "node": "Format Final Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DNI Validation - Get Token": {
      "main": [
        [
          {
            "node": "DNI Validation Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DNI Validation Request": {
      "main": [
        [
          {
            "node": "Process DNI Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process DNI Validation": {
      "main": [
        [
          {
            "node": "Update Session - DNI Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session - DNI Validation": {
      "main": [
        [
          {
            "node": "Write JSONBin 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Format DNI Validation Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format DNI Validation Response": {
      "main": [
        [
          {
            "node": "Send WhatsApp Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Maestros Token": {
      "main": [
        [
          {
            "node": "Get Especialidades",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Especialidades": {
      "main": [
        [
          {
            "node": "Format Maestros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Especialidad Selection Decision": {
      "main": [
        [
          {
            "node": "Get Dias Horarios Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Dias Horarios Token": {
      "main": [
        [
          {
            "node": "Get Dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Dias": {
      "main": [
        [
          {
            "node": "Get Rangos Horarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Rangos Horarios": {
      "main": [
        [
          {
            "node": "Process Dynamic Maestros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Dynamic Maestros": {
      "main": [
        [
          {
            "node": "Update Session - Dynamic Maestros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session - Dynamic Maestros": {
      "main": [
        [
          {
            "node": "Write JSONBin - Dynamic Maestros",
            "type": "main",
            "index": 0
          },
          {
            "node": "Format Dynamic Maestros Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Dynamic Maestros Response": {
      "main": [
        [
          {
            "node": "Send WhatsApp Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "d5c06e24-2b0a-404a-80c3-d2872749e3c2",
  "meta": {
    "instanceId": "556514cf317cac5c724bf084ccbb32127ff27cc56f225fb39f131295f3c7f3d0"
  },
  "id": "v8eKjjtCYC1WyQw8",
  "tags": []
}