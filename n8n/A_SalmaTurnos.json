{
  "name": "A_SalmaTurnos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ac247fd3-9ca7-42a3-8942-7ea8c321c46d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -304,
        -480
      ],
      "id": "91d76977-bce2-4213-8a4c-2985d7d7252b",
      "name": "Webhook Start",
      "webhookId": "e3b2122c-9d00-4104-b64f-91553cc08f8c"
    },
    {
      "parameters": {
        "jsCode": "// Parse WhatsApp Message\nconst items = $input.all();\nconst message = items[0].json.body.data.message;\n\nif (!message || message.type !== 'chat') {\n  return [{ json: { error: \"Invalid message type\" } }];\n}\n\nconst chatId = message.from;\nconst messageText = message.body?.trim() || \"\";\nconst messageId = message.id;\n\nreturn [{\n  json: {\n    chatId: chatId,\n    messageText: messageText,\n    messageId: messageId,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32,
        -416
      ],
      "id": "dbada218-2589-48d3-a6c4-1304cd6d67f4",
      "name": "Parse Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salmasalud.com.ar/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"user\": \"admin\",\n  \"password\": \"1234\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        160,
        -672
      ],
      "id": "4c89f716-7072-4817-97e5-d1b2d4cabf0d",
      "name": "Get Auth Token"
    },
    {
      "parameters": {
        "url": "https://api.jsonbin.io/v3/b/687566205d646f1c273fa03e",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Master-Key",
              "value": "$2a$10$x6g.oxG8TSRAhrOyGXNhjOcipTIiu9RU3X/h2S0DC4kbIalK9KxEO"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        -256
      ],
      "id": "4cbd17b9-cf3f-45a7-aa5c-15f93b635256",
      "name": "Get User Session"
    },
    {
      "parameters": {
        "url": "https://api.salmasalud.com.ar/especialidades",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Get Auth Token').first().json.token}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        368,
        -640
      ],
      "id": "b07f5ef8-bd9f-4592-83c1-103dcbd8bea7",
      "name": "Get Especialidades"
    },
    {
      "parameters": {
        "jsCode": "// Process User State and Determine Next Step - FIXED for n8n 1.75.2+\n// Solution 3: Add Try-Catch for All Node References\n\n// üîç EXECUTION TRACKING - Double execution fix\nconst executionId = Math.random().toString(36).substr(2, 9);\nconsole.log('üîç EXECUTION START - Process State Logic:', executionId);\nconsole.log('üîç Execution timestamp:', new Date().toISOString());\nconsole.log('üîç Input items count:', $input.all().length);\nconsole.log('üîç Input data preview:', JSON.stringify($input.all().map(item => ({ keys: Object.keys(item.json || {}), source: item.json?.source || 'unknown' })), null, 2));\n\n// üõ°Ô∏è CRITICAL FIX: Single execution guard to prevent double execution\nconst inputItems = $input.all();\nif (!inputItems || inputItems.length === 0) {\n  console.log('üõë GUARD: No input items, aborting execution');\n  return [];\n}\n\n// Check if we have duplicate input items (indicating double execution)\nif (inputItems.length > 2) {\n  console.log('üõë GUARD: Too many input items detected:', inputItems.length, '- potential double execution');\n  console.log('üõë GUARD: Using only the first valid input to prevent duplicates');\n}\n\nlet chatId = '';\nlet messageText = '';\nlet token = '';\nlet especialidades = [];\n\n// Wrap all node references in try-catch blocks to prevent read-only property errors\ntry {\n  const parseMessageData = $('Parse Message').first().json;\n  if (parseMessageData) {\n    chatId = parseMessageData.chatId || '';\n    messageText = (parseMessageData.messageText || '').trim();\n  }\n} catch (error) {\n  console.log('Parse Message node not accessible:', error.message);\n  chatId = '';\n  messageText = '';\n}\n\ntry {\n  const authTokenData = $(\"Get Auth Token\").first().json;\n  if (authTokenData && authTokenData.token) {\n    token = authTokenData.token;\n  }\n} catch (error) {\n  console.log('Get Auth Token node not accessible:', error.message);\n  token = '';\n}\n\n// Solution 1: Add Node Reference Validation for Especialidades\ntry {\n  const especialidadesItems = $('Get Especialidades').all();\n    \n  if (especialidadesItems && especialidadesItems.length > 0) {\n    especialidades = especialidadesItems.map(item => item.json);\n  }\n} catch (error) {\n  console.log('Get Especialidades node not executed or accessible:', error.message);\n  especialidades = [];\n}\n\n// Solution 2: Create Deep Copies of Objects - Get user session from JSONBin\nlet allSessions = {};\nlet userSession = null;\n\ntry {\n  const jsonbinResponse = $('Get User Session').first().json;\n  if (jsonbinResponse && jsonbinResponse.record && jsonbinResponse.record.sessions) {\n    // Create deep copy to avoid read-only issues\n    allSessions = JSON.parse(JSON.stringify(jsonbinResponse.record.sessions));\n    console.log('‚úÖ JSONBin data loaded, total users:', Object.keys(allSessions).length);\n  } else {\n    console.log('‚ö†Ô∏è No existing JSONBin data, creating new structure');\n    allSessions = {};\n  }\n  userSession = allSessions[chatId];\n} catch (error) {\n  console.log('‚ùå Error reading JSONBin, creating new structure:', error.message);\n  allSessions = {};\n}\n\n// Initialize new user session if doesn't exist with validation\nif (chatId && !allSessions[chatId]) {\n  // Solution 2: Create objects without modifying frozen/read-only properties\n  allSessions[chatId] = {\n    chatId: chatId,\n    estado: \"INICIO\",\n    datos: {},\n    createdAt: new Date().toISOString(),\n    lastActivity: new Date().toISOString()\n  };\n  console.log('üÜï Initialized new user session for:', chatId);\n} else if (!chatId) {\n  console.log('‚ùå Cannot initialize session: chatId is empty');\n  // Return early to prevent processing with empty chatId\n  return {\n    json: {\n      chatId: '',\n      isValid: false,\n      response: {\n        message: \"‚ùå Error de configuraci√≥n. Por favor intente nuevamente.\"\n      },\n      allSessions: {},\n      token: token,\n      needsDniValidation: false,\n      needsDaysData: false,\n      needsHoursData: false,\n      needsApiSubmission: false,\n      needsConfirmationDisplay: false,\n      isCanceled:false,\n      currentState: \"ERROR\",\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n\n// Get current user session with validation\nuserSession = allSessions[chatId];\nif (!userSession) {\n  console.log('‚ùå No user session found, creating default');\n  userSession = {\n    chatId: chatId,\n    estado: \"INICIO\",\n    datos: {},\n    createdAt: new Date().toISOString(),\n    lastActivity: new Date().toISOString()\n  };\n  allSessions[chatId] = userSession;\n}\n\nconst isNewUser = !userSession.datos || Object.keys(userSession.datos).length === 0;\n\n// Update last activity (create new object to avoid modifying frozen objects)\nuserSession = {\n  ...userSession,\n  lastActivity: new Date().toISOString()\n};\nallSessions[chatId] = userSession;\n\nconsole.log(isNewUser ? 'üÜï New user detected' : 'üîÑ Existing user session loaded');\n\n// Process based on current state\nlet response = {};\nlet newState = userSession.estado;\nlet updateData = { ...userSession.datos };\nlet isValid = true;\nlet errorMessage = \"\";\nlet needsDniValidation = false;\nlet needsDaysData = false;\nlet needsHoursData = false;\nlet needsApiSubmission = false;\nlet needsConfirmationDisplay = false;\nlet isCanceled = false;\nlet needsInitialMessage = false;\n\n// CRITICAL FIX: Detect if we're transitioning from INICIO/COMPLETADO states\nconst currentState = userSession.estado || \"INICIO\";\nlet skipDniProcessing = (currentState === \"INICIO\" || currentState === \"COMPLETADO\");\n\nswitch (userSession.estado) {\n  case \"INICIO\":\n  case \"COMPLETADO\":\n    // Start or restart flow - ONLY show welcome message\n    if (userSession.estado === \"COMPLETADO\") {\n      updateData = {}; // Clear previous data\n    }\n    needsInitialMessage = true;\n    response = {\n      message: \"üè• ¬°Bienvenido al sistema de turnos autom√°ticos de Salma Salud!\\n\\n Este asistente virtual lo guiar√° paso a paso para reservar su turno en nuestra sede de:\\n\\n üìç Av. Pres. Dr. Arturo Umberto Illia 3198 \\n\\n üîÑ Importante:La reserva ser√° confirmada luego de la revisi√≥n y autorizaci√≥n por parte del equipo de Salma Salud.\\n\\n Para comenzar, por favor indique su n√∫mero de DNI\\n(solo n√∫meros, sin puntos).\"\n    };\n    newState = \"ESPERANDO_DNI\";\n    console.log('üîÑ State transition: ' + currentState + ' -> ESPERANDO_DNI (needsInitialMessage: true)');\n    break;\n\n  case \"ESPERANDO_DNI\":\n    // CRITICAL: Skip DNI processing if we just transitioned from INICIO/COMPLETADO\n    if (skipDniProcessing) {\n      console.log('‚è≠Ô∏è Skipping DNI processing - just transitioned from ' + currentState + ' state');\n      // The user will need to send another message for actual DNI validation\n      // Keep current response (welcome message) and don't process current message as DNI\n      // DO NOT break here - we want to keep the welcome message from the previous case\n      console.log('üìù Keeping welcome message, user needs to send DNI in next message');\n      break;\n    }\n    \n    // Process actual DNI input from user's next message\n    console.log('üîç DNI Processing - messageText:', messageText);\n    \n    // Clean and validate DNI\n    const cleanDNI = messageText.replace(/[^0-9]/g, '');\n    console.log('üîç DNI Processing - cleanDNI:', cleanDNI);\n    console.log('üîç DNI Processing - length:', cleanDNI.length);\n    \n    if (!cleanDNI || cleanDNI.length < 7 || cleanDNI.length > 8) {\n      isValid = false;\n      errorMessage = `‚ùå DNI inv√°lido\\n\\nPor favor ingrese solo n√∫meros, entre 7 y 8 d√≠gitos.\\n\\nüìù Formatos aceptados:\\n‚Ä¢ 25430441\\n‚Ä¢ 25.430.441\\n‚Ä¢ 25 430 441\\n\\nüí° Intente nuevamente, asegur√°ndose de escribir solo el n√∫mero de su DNI.`;\n      // needsInitialMessage stays false - this is NOT an initial message, it's an error\n      console.log('üîç DNI ERROR SOURCE: Process State Logic - Format validation');\n      console.log('‚ùå Validation failed for state:', userSession.estado);\n      console.log('‚ùå Error message:', errorMessage);\n      console.log('‚ùå isValid flag:', isValid);\n    } else {\n      updateData.dni = cleanDNI;\n      needsDniValidation = true;\n      isValid= true;\n      newState = \"VALIDANDO_DNI\";\n      response = {\n        message: \"‚è≥ Validando DNI...\"\n      };\n      console.log('‚úÖ CRITICAL FIX: Setting needsDniValidation = true for actual DNI processing');\n    }\n    break;\n\n  case \"ESPERANDO_ESPECIALIDAD\":\n    const especialidadId = parseInt(messageText);\n    \n    // Ensure especialidades is an array\n    let especialidadesArray = [];\n    if (Array.isArray(especialidades)) {\n      especialidadesArray = especialidades;\n    } else if (especialidades && Array.isArray(especialidades)) {\n      especialidadesArray = especialidades;\n    }\n    \n    const especialidad = especialidadesArray.find(e => e.idEspecialidad === especialidadId);\n    \n    if (!especialidad) {\n      isValid = false;\n      let opciones = especialidadesArray.map(e => `${e.idEspecialidad}. ${e.descripcion}`).join('\\n');\n      errorMessage = `‚ùå Opci√≥n no v√°lida\\n\\nNo se reconoce el valor ingresado\\n\\nüìã Opciones v√°lidas:\\n\\n${opciones}\\n\\nüí° Por favor, responda con el n√∫mero\\ncorrespondiente a la especialidad deseada.\\nEjemplo: ingrese 2 para elegir \"clinica medica\"`;\n      console.log('‚ùå Validation failed for state:', userSession.estado);\n      console.log('‚ùå Error message:', errorMessage);\n      console.log('‚ùå isValid flag:', isValid);\n    } else {\n      updateData.especialidad = especialidad;\n      needsDaysData = true;\n      newState = \"CARGANDO_DIAS\";\n      response = {\n        message: `‚è≥ Obteniendo d√≠as disponibles para ${especialidad.descripcion}...`\n      };\n      console.log('‚úÖ CRITICAL FIX: Setting needsDaysData = true for specialty selection');\n    }\n    break;\n\n  case \"ESPERANDO_DIA\":\n    const diaId = parseInt(messageText);\n    if (!updateData.diasDisponibles || !updateData.diasDisponibles[diaId]) {\n      isValid = false;\n      if (updateData.diasDisponibles) {\n        let opciones = Object.keys(updateData.diasDisponibles).map(key => `${key}. ${updateData.diasDisponibles[key]}`).join('\\n');\n        errorMessage = `‚ùå No se reconoce el valor ingresado\\n\\nüìã Opciones v√°lidas:\\n\\n${opciones}\\n\\nüí° Puede seleccionar uno o m√°s d√≠as respondiendo con los n√∫meros correspondientes, separados por comas.\\n\\nüìù Ejemplo v√°lido: 1,3,5 \\nPor favor, intente nuevamente.`;\n      console.log('‚ùå Validation failed for state:', userSession.estado);\n      console.log('‚ùå Error message:', errorMessage);\n      console.log('‚ùå isValid flag:', isValid);\n      } else {\n        errorMessage = \"‚ùå Error: D√≠as no cargados. Por favor inicie nuevamente el proceso.\";\n      console.log('‚ùå Validation failed for state:', userSession.estado);\n      console.log('‚ùå Error message:', errorMessage);\n      console.log('‚ùå isValid flag:', isValid);\n      }\n    } else {\n      updateData.diaSeleccionado = {\n        id: diaId,\n        descripcion: updateData.diasDisponibles[diaId]\n      };\n      needsHoursData = true;\n      newState = \"CARGANDO_HORARIOS\";\n      response = {\n        message: `‚è≥ Obteniendo horarios disponibles para ${updateData.diaSeleccionado.descripcion}...`\n      };\n      console.log('‚úÖ CRITICAL FIX: Setting needsHoursData = true for day selection');\n    }\n    break;\n\n  case \"ESPERANDO_HORARIO\":\n    const horarioId = parseInt(messageText);\n    if (!updateData.horariosDisponibles || !updateData.horariosDisponibles[horarioId]) {\n      isValid = false;\n      if (updateData.horariosDisponibles) {\n        let opciones = Object.keys(updateData.horariosDisponibles).map(key => `${key}. ${updateData.horariosDisponibles[key]}`).join('\\n');\n        errorMessage = `‚ùå No se reconoce el valor ingresado\\n\\nüìã Opciones v√°lidas:\\n\\n${opciones}\\n\\nüí° Puede seleccionar uno o m√°s rangos horarios respondiendo con los n√∫meros correspondientes, separados por comas.\\n\\nüìù Ejemplo v√°lido: 1,3,5 \\nPor favor, intente nuevamente.`;\n      console.log('‚ùå Validation failed for state:', userSession.estado);\n      console.log('‚ùå Error message:', errorMessage);\n      console.log('‚ùå isValid flag:', isValid);\n      } else {\n        errorMessage = \"‚ùå Error: Horarios no cargados. Por favor inicie nuevamente el proceso.\";\n      console.log('‚ùå Validation failed for state:', userSession.estado);\n      console.log('‚ùå Error message:', errorMessage);\n      console.log('‚ùå isValid flag:', isValid);\n      }\n    } else {\n      updateData.horarioSeleccionado = {\n        id: horarioId,\n        descripcion: updateData.horariosDisponibles[horarioId]\n      };\n      \n      // Show confirmation\n      const resumen = `üìã Resumen de su solicitud de turno\\n\\n` +\n                     `üë§ Paciente: ${updateData.paciente?.nombre || updateData.paciente?.name || updateData.paciente?.nombreCompleto || \"Paciente\"}\\n` +\n                     `üè• Especialidad: ${updateData.especialidad.descripcion}\\n` +\n                     `üìÖ D√≠a elegidos: ${updateData.diaSeleccionado.descripcion}\\n` +\n                     `üïê Horario preferidos: ${updateData.horarioSeleccionado.descripcion}\\n\\n` +\n                     `‚ö†Ô∏è Recuerde que esta es una solicitud de turno y su confirmaci√≥n depender√° de la disponibilidad del mismo ` +\n                     `¬øConfirma que desea enviar esta solicitud?\\n\\n` +\n                     `‚úÖ Escriba \"SI\" para confirmar\\n` +\n                     `‚ùå Escriba \"NO\" para cancelar`;\n      \n      response = {\n        message: resumen\n      };\n      newState = \"ESPERANDO_CONFIRMACION\";\n      needsConfirmationDisplay = true;\n      console.log('‚úÖ CRITICAL FIX: Setting needsConfirmationDisplay = true for hour selection');\n    }\n    break;\n\n  case \"ESPERANDO_CONFIRMACION\":\n    const confirmacionText = messageText.toUpperCase().trim();\n    \n    if (confirmacionText === \"SI\") {\n      needsApiSubmission = true;\n      newState = \"PROCESANDO_API\";\n      response = {\n        message: \"‚úÖ Turno confirmado\\n\\nProcesando su solicitud...\"\n      };\n      console.log('‚úÖ CRITICAL FIX: Setting needsApiSubmission = true for confirmation');\n    } else if (confirmacionText === \"NO\") {\n      updateData = {};\n      newState = \"INICIO\";\n      isCanceled = true;\n      response = {\n        message: \"‚ùå Turno cancelado\\n\\nSu solicitud ha sido cancelada correctamente\\n\\nüìÖ¬øDesea agendar un nuevo turno?\\n\\n‚úâÔ∏è Env√≠e cualquier mensaje para comenzar nuevamente.\"\n      };\n    } else {\n      isValid = false;\n      errorMessage = \"‚ùå No se reconoce el valor ingresado\\\\n\\\\nOpciones v√°lidas:\\\\n‚úÖ Escriba \\\"SI\\\" para confirmar\\\\n‚ùå Escriba \\\"NO\\\" para cancelar\";\n      console.log('‚ùå Validation failed for state:', userSession.estado);\n      console.log('‚ùå Error message:', errorMessage);\n      console.log('‚ùå isValid flag:', isValid);\n    }\n    break;\n\n  default:\n    // Unknown state, restart\n    needsInitialMessage = true;\n    response = {\n      message: \"üè• ¬°Bienvenido al sistema de turnos autom√°ticos de Salma Salud!\\n\\n Este asistente virtual lo guiar√° paso a paso para reservar su turno en nuestra sede de:\\n\\n üìç Av. Pres. Dr. Arturo Umberto Illia 3198 \\n\\n üîÑ Importante:La reserva ser√° confirmada luego de la revisi√≥n y autorizaci√≥n por parte del equipo de Salma Salud.\\n\\n Para comenzar, por favor indique su n√∫mero de DNI\\n(solo n√∫meros, sin puntos).\"\n    };\n    newState = \"ESPERANDO_DNI\";\n    updateData = {};\n}\n\n// CRITICAL FIX: Override flags only for skip mode (transition states)\n// This ensures that when users are actually processing data, the flags are set correctly\nif (skipDniProcessing) {\n  console.log('üõë SKIP MODE: Overriding all flags to false for state transition from ' + currentState);\n  // Force all processing flags to false to prevent parallel execution of validation nodes\n  needsDniValidation = false;\n  needsDaysData = false;\n  needsHoursData = false;\n  needsApiSubmission = false;\n  needsConfirmationDisplay = false;\n  isCanceled = false;\n  // Do NOT override needsInitialMessage here - it should remain true for initial states\n}\n\n// Update session data with validation\nif (chatId && userSession) {\n  // Solution 2: Create new object instead of modifying existing one\n  allSessions[chatId] = {\n    chatId: chatId,\n    estado: isValid ? newState : userSession.estado,\n    datos: isValid ? updateData : userSession.datos,\n    createdAt: userSession.createdAt || new Date().toISOString(),\n    lastActivity: new Date().toISOString()\n  };\n} else {\n  console.log('‚ùå Cannot update session: missing chatId or userSession');\n}\n\n// Clean message for WhatsApp\nlet finalMessage = isValid ? response.message : errorMessage;\nlet cleanedMessage = finalMessage\n\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");\n\n// üîç EXECUTION TRACKING - End\nconsole.log('üîç EXECUTION END - Process State Logic:', executionId);\nconsole.log('üîç Final output - isValid:', isValid, 'currentState:', isValid ? newState : userSession.estado);\nconsole.log('üîç Final flags - needsDniValidation:', needsDniValidation, 'needsDaysData:', needsDaysData, 'needsHoursData:', needsHoursData);\n\nreturn {\n  json: {\n    chatId: chatId,\n    isValid: isValid,\n    response: {\n      message: cleanedMessage\n    },\n    allSessions: allSessions,\n    token: token,\n    needsDniValidation: needsDniValidation,\n    needsDaysData: needsDaysData,\n    needsHoursData: needsHoursData,\n    needsApiSubmission: needsApiSubmission,\n    needsConfirmationDisplay: needsConfirmationDisplay,\n    isCanceled: isCanceled,\n    needsInitialMessage: needsInitialMessage,\n    currentState: isValid ? newState : userSession.estado,\n    timestamp: new Date().toISOString(),\n    executionId: executionId\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        -112
      ],
      "id": "87bb8c83-a1dd-4092-8013-a86de1cabe8a",
      "name": "Process State Logic"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.isValid }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "rightType": "boolean"
              },
              "id": "e0b7e561-d133-4b65-87cd-7dc99e7da652"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        752,
        -864
      ],
      "id": "0401e43c-4f2d-46aa-ab82-ff938d068b51",
      "name": "Check Error Routing"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needsInitialMessage }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "36bd5137-774b-46e2-80b6-1b55568360f4"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        752,
        -704
      ],
      "id": "21960b8d-554b-48f5-8303-4cff814fce6b",
      "name": "Check Initial State"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needsDniValidation }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "rightType": "boolean"
              },
              "id": "needsDniValidation-check"
            },
            {
              "id": "c0681459-dff3-4a6c-918e-5cc07305bc61",
              "leftValue": "={{ $json.isValid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        752,
        -544
      ],
      "id": "65545af6-1c68-4db1-8061-da72c6f1e468",
      "name": "Check DNI Validation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needsDaysData }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "rightType": "boolean"
              },
              "id": "519675b7-296b-4e9b-a7e8-fce41e14fd4c"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        752,
        -416
      ],
      "id": "417ade8a-faea-4cfb-990f-4fd8111aa8ab",
      "name": "Check Days Data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needsHoursData }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "rightType": "boolean"
              },
              "id": "cb5b2ee5-a0dc-426b-9ecb-605a3580a797"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        752,
        -256
      ],
      "id": "75523b7e-b1d6-40a5-a56b-fac6cb979234",
      "name": "Check Hours Data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needsApiSubmission }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "rightType": "boolean"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        720,
        -80
      ],
      "id": "ae00a378-6632-46bf-8aa5-6b131ce1c77c",
      "name": "Check API Submission"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needsConfirmationDisplay }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "rightType": "boolean"
              },
              "id": "f5d059a7-1524-4b4c-8258-b200851f8074"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        720,
        80
      ],
      "id": "68ee728f-2507-46b4-8c5a-8b57e923bbf0",
      "name": "Check Confirmation Display"
    },
    {
      "parameters": {
        "url": "=https://api.salmasalud.com.ar/paciente-by-documento/{{ $('Process State Logic').first().json.allSessions[$('Process State Logic').first().json.chatId].datos.dni }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Process State Logic').first().json.token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1040,
        -688
      ],
      "id": "87e5202e-2883-449d-98c8-63ea75aeeff4",
      "name": "Validate DNI",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Process DNI Validation Result - WITH EXTENSIVE DEBUGGING\nconst stateData = $('Process State Logic').first().json;\nconst chatId = stateData.chatId;\nlet allSessions = stateData.allSessions;\n\nconsole.log('üîç DEBUG: Starting Process DNI Result with chatId:', chatId);\nconsole.log('üîç DEBUG: State data:', JSON.stringify(stateData, null, 2));\n\n// CRITICAL FIX: Check if format validation already failed in Process State Logic\nif (stateData.isValid === false) {\n  console.log('üõë EARLY EXIT: Format validation failed in Process State Logic, skipping API validation');\n  console.log('üõë Reason: Preventing duplicate error messages');\n  console.log('üõë isValid:', stateData.isValid);\n  console.log('üõë needsDniValidation:', stateData.needsDniValidation);\n  console.log('üõë This node should NOT execute when format validation fails');\n  // Return empty result to prevent this node from generating output\n  // The error message from Process State Logic will be used instead\n  return [];\n}\n\n// Additional safety check: Only proceed if needsDniValidation is true\nif (stateData.needsDniValidation !== true) {\n  console.log('üõë EARLY EXIT: needsDniValidation is not true, this node should not execute');\n  console.log('üõë needsDniValidation:', stateData.needsDniValidation);\n  console.log('üõë isValid:', stateData.isValid);\n  return [];\n}\n\n// Only proceed if format validation passed\nconsole.log('‚úÖ Format validation passed, proceeding with API validation');\n\n// Get especialidades with validation\nlet especialidades = [];\ntry {\n  // FIXED: Use .all() instead of .first().json to get all items from the node\n  const especialidadesItems = $('Get Especialidades').all();\n  \n  console.log('üìä Get Especialidades items count:', especialidadesItems.length);\n  console.log('üìä Get Especialidades items structure:', JSON.stringify(especialidadesItems, null, 2));\n  \n  let especialidadesResponse = null;\n  if (especialidadesItems && especialidadesItems.length > 0) {\n    // Extract the actual data from the first item's json property\n    especialidadesResponse = especialidadesItems.map(item => item.json);\n    console.log('üîç DEBUG: Raw especialidades data type:', typeof especialidadesResponse);\n    console.log('üîç DEBUG: Is especialidades an array?', Array.isArray(especialidadesResponse));\n    console.log('üîç DEBUG: Especialidades length:', especialidadesResponse?.length);\n    console.log('üîç DEBUG: First specialty item:', especialidadesResponse?.[0]);\n    console.log('üîç DEBUG: All specialties:', JSON.stringify(especialidadesResponse, null, 2));\n  } else {\n    console.log('‚ö†Ô∏è No items returned from Get Especialidades node');\n    especialidadesResponse = null;\n  }\n  \n  console.log('üìä Raw especialidades response:', JSON.stringify(especialidadesResponse, null, 2));\n  \n  // Only process if we have valid response data\n  if (!especialidadesResponse) {\n    console.log('‚ö†Ô∏è No especialidades data available');\n    especialidades = [];\n  } else if (Array.isArray(especialidadesResponse)) {\n    especialidades = especialidadesResponse;\n  } else if (especialidadesResponse && typeof especialidadesResponse === 'object') {\n    // If it's wrapped in an object, try to extract the array\n    if (especialidadesResponse.data && Array.isArray(especialidadesResponse.data)) {\n      especialidades = especialidadesResponse.data;\n    } else if (especialidadesResponse.especialidades && Array.isArray(especialidadesResponse.especialidades)) {\n      especialidades = especialidadesResponse.especialidades;\n    } else if (especialidadesResponse.idEspecialidad) {\n      // Single specialty object\n      especialidades = [especialidadesResponse];\n    }\n  }\n  \n  console.log('‚úÖ Especialidades processed:', especialidades.length + ' items');\n  console.log('üìã Especialidades array:', JSON.stringify(especialidades, null, 2));\n} catch (error) {\n  console.log('‚ùå Error processing especialidades:', error.message);\n  console.log('‚ùå Error stack:', error.stack);\n  especialidades = [];\n}\n\n// Check if DNI validation was successful\nlet dniValid = false;\nlet errorMessage = \"\";\n\ntry {\n  const dniResponse = $('Validate DNI').first().json;\n  console.log('üîç DEBUG: DNI Response:', JSON.stringify(dniResponse, null, 2));\n  if (dniResponse && (dniResponse.idPaciente || dniResponse.id)) {\n    dniValid = true;\n    // Store patient data\n    allSessions[chatId].datos.paciente = dniResponse;\n    console.log('‚úÖ DEBUG: DNI Valid, patient data stored');\n  } else {\n    errorMessage = \"‚ùå DNI no encontrado en el sistema\\n\\nPor favor verifique el n√∫mero ingresado o comun√≠quese con la cl√≠nica para registrarse.\";\n    console.log('üîç DNI ERROR SOURCE: Process DNI Result - API validation');\n    console.log('‚ùå DEBUG: DNI Invalid, no patient found');\n  }\n} catch (error) {\n  console.log('DNI Validation Error:', error.message);\n  console.log('‚ùå Error stack:', error.stack);\n  errorMessage = \"‚ùå Error validando DNI\\n\\nPor favor intente nuevamente o verifique el n√∫mero ingresado.\";\n}\n\nlet responseMessage = \"\";\n\nif (dniValid) {\n  // Show specialties\n  allSessions[chatId].estado = \"ESPERANDO_ESPECIALIDAD\";\n  \n  // Extract patient name from API response\n  const pacienteData = allSessions[chatId].datos.paciente;\n  let patientName = \"\";\n  \n  // Try different possible name fields from the API response\n  if (pacienteData) {\n    patientName = pacienteData.nombre || \n                 pacienteData.name || \n                 pacienteData.nombreCompleto || \n                 pacienteData.fullName || \n                 pacienteData.nombrePaciente || \n                 pacienteData.nombreApellido || \n                 pacienteData.apellidoNombre || \n                 \"\";\n  }\n  \n  console.log('üë§ DEBUG: Patient name extracted:', patientName);\n  \n  // Build the welcome message with or without name\n  let especialidadesText = \"\";\n  if (patientName && patientName.trim() !== \"\") {\n    especialidadesText = `üëã ¬°Hola ${patientName.trim()}!\\n\\nüë®‚Äç‚öïÔ∏è Seleccione la especialidad para la que desea reservar un turno:\\n\\n`;\n  } else {\n    especialidadesText = \"üë®‚Äç‚öïÔ∏è Seleccione la especialidad para la que desea reservar un turno:\\n\\n\";\n  }\n  \n  console.log('üîÑ DEBUG: Starting forEach with', especialidades.length, 'items');\n  console.log('üîÑ DEBUG: Initial especialidadesText:', especialidadesText);\n  \n  // Validate especialidades is an array before forEach\n  if (Array.isArray(especialidades) && especialidades.length > 0) {\n    console.log('üîÑ Building especialidades list with', especialidades.length, 'items');\n    \n    // CRITICAL FIX: Build the list directly without intermediate variable\n    // Process each specialty and append immediately\n    especialidades.forEach((esp, index) => {\n      console.log(`üîÑ DEBUG: Processing specialty ${index + 1}:`, esp);\n      console.log(`üîÑ DEBUG: Before adding item ${index + 1}, text length:`, especialidadesText.length);\n      \n      if (esp && esp.idEspecialidad && esp.descripcion) {\n        const listItem = `${esp.idEspecialidad}. ${esp.descripcion}\\n`;\n        console.log(`üîÑ DEBUG: Adding item: \"${listItem}\"`);\n        \n        // Append directly to especialidadesText to avoid string concatenation issues\n        especialidadesText += listItem;\n\n        // especialidadesText +=`\\n\\nüìå Responda con el n√∫mero correspondiente (por ejemplo: '2').`;        \n        console.log(`üîÑ DEBUG: After adding item ${index + 1}, text length:`, especialidadesText.length);\n        console.log(`üîÑ DEBUG: Current text:`, especialidadesText);\n        console.log(`‚úÖ Added specialty: ${esp.idEspecialidad}. ${esp.descripcion}`);\n      } else {\n        console.log('‚ö†Ô∏è Invalid specialty object at index', index, ':', esp);\n      }\n    });\n    especialidadesText +=`\\n\\nüìå Responda con el n√∫mero correspondiente (por ejemplo: 2).`;\n    console.log('‚úÖ DEBUG: Final especialidadesText length:', especialidadesText.length);\n    console.log('‚úÖ DEBUG: Final especialidadesText content:', especialidadesText);\n    console.log(`üìä Final especialidades text (${especialidadesText.length} chars):`);\n    console.log('üìù Final text content:', especialidadesText);\n  } else {\n    console.log('‚ö†Ô∏è No especialidades available or invalid format. Data:', especialidades);\n    especialidadesText += \"‚ùå No hay especialidades disponibles en este momento.\\n\\nPor favor intente m√°s tarde.\";\n    // Keep in DNI validation state to allow retry\n    allSessions[chatId].estado = \"ESPERANDO_DNI\";\n  }\n  \n  responseMessage = especialidadesText;\n  console.log('üßπ DEBUG: Before cleaning, responseMessage:', responseMessage);\n} else {\n  // Keep in DNI state with error\n  allSessions[chatId].estado = \"ESPERANDO_DNI\";\n  responseMessage = errorMessage;\n  console.log('üßπ DEBUG: Before cleaning, error responseMessage:', responseMessage);\n}\n\n// CRITICAL FIX: Simplified message cleaning - avoid aggressive regex that might truncate content\nlet cleanedMessage = responseMessage\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")  // Remove markdown bold\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");       // Clean list items\n\nconsole.log('üßπ DEBUG: After cleaning, cleanedMessage:', cleanedMessage);\nconsole.log('üìä DEBUG: Final cleaned message length:', cleanedMessage.length);\n\nconst result = [{\n  json: {\n    chatId: chatId,\n    response: {\n      message: cleanedMessage\n    },\n    allSessions: allSessions,\n    dniValid: dniValid,\n    timestamp: new Date().toISOString()\n  }\n}];\n\nconsole.log('üì§ DEBUG: Final return result:', JSON.stringify(result, null, 2));\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        -752
      ],
      "id": "1cf64aa5-0ddd-4f1a-b4aa-0b2978c3ba73",
      "name": "Process DNI Result"
    },
    {
      "parameters": {
        "url": "=https://api.salmasalud.com.ar/dias?idEspecialidad={{ $('Process State Logic').first().json.allSessions[$('Process State Logic').first().json.chatId].datos.especialidad.idEspecialidad }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Process State Logic').first().json.token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        960,
        -480
      ],
      "id": "5f0a069b-456c-4853-a14b-69472b456a4d",
      "name": "Get Days"
    },
    {
      "parameters": {
        "jsCode": "// Process Days Data - WITH EXTENSIVE DEBUGGING\nconst stateData = $('Process State Logic').first().json;\nconst chatId = stateData.chatId;\nlet allSessions = stateData.allSessions;\n\nconsole.log('üîç DEBUG: Starting Process Days Result with chatId:', chatId);\nconsole.log('üîç DEBUG: State data:', JSON.stringify(stateData, null, 2));\n\n// Get days from API response\n// FIXED: Get days from API response - use .all() to get all items from the node\nconst diasItems = $('Get Days').all();\nlet diasResponse = null;\n\nconsole.log('üìä Get Days items count:', diasItems.length);\nconsole.log('üìä Get Days items structure:', JSON.stringify(diasItems, null, 2));\n\nif (diasItems && diasItems.length > 0) {\n  // FIXED: Extract the actual data from all items and map to get the json data\n  diasResponse = diasItems.map(item => item.json);\n  console.log('üîç DEBUG: Raw days data type:', typeof diasResponse);\n  console.log('üîç DEBUG: Is days an array?', Array.isArray(diasResponse));\n  console.log('üîç DEBUG: Days length:', diasResponse?.length);\n  console.log('üîç DEBUG: All days:', JSON.stringify(diasResponse, null, 2));\n} else {\n  console.log('‚ö†Ô∏è No items returned from Get Days node');\n  diasResponse = null;\n}\n\nlet diasObj = {};\n\nconsole.log('üîç DEBUG: Days API Response:', JSON.stringify(diasResponse, null, 2));\n\n// Process days - handle both array and single object cases\nif (Array.isArray(diasResponse)) {\n  console.log('‚úÖ Processing days array with', diasResponse.length, 'items');\n  diasResponse.forEach((dia, index) => {\n    console.log(`üîÑ Processing day ${index + 1}:`, dia);\n    if (dia.idTipoDia && dia.descripcion) {\n      diasObj[dia.idTipoDia] = dia.descripcion;\n      console.log(`‚úÖ Added day: ${dia.idTipoDia}. ${dia.descripcion}`);\n    } else {\n      console.log('‚ö†Ô∏è Invalid day object at index', index, ':', dia);\n    }\n  });\n} else if (diasResponse && typeof diasResponse === 'object' && diasResponse.idTipoDia && diasResponse.descripcion) {\n  // FIXED: Handle single day object case properly\n  console.log('‚úÖ Processing single day object');\n  diasObj[diasResponse.idTipoDia] = diasResponse.descripcion;\n  console.log(`‚úÖ Added single day: ${diasResponse.idTipoDia}. ${diasResponse.descripcion}`);\n} else if (diasResponse && typeof diasResponse === 'object') {\n  // Handle other object formats (wrapped data, etc.)\n  console.log('‚ö†Ô∏è Unexpected object format for days response, checking for wrapped data');\n  if (diasResponse.data && Array.isArray(diasResponse.data)) {\n    diasResponse.data.forEach((dia, index) => {\n      if (dia.idTipoDia && dia.descripcion) {\n        diasObj[dia.idTipoDia] = dia.descripcion;\n        console.log(`‚úÖ Added wrapped day: ${dia.idTipoDia}. ${dia.descripcion}`);\n      }\n    });\n  } else {\n    console.log('‚ö†Ô∏è Could not process object format:', diasResponse);\n  }\n}\n\nconsole.log('üìä Final days object:', JSON.stringify(diasObj, null, 2));\n\n// Store days data in session\nallSessions[chatId].datos.diasDisponibles = diasObj;\nallSessions[chatId].estado = \"ESPERANDO_DIA\";\n\n// Format days for display\nlet diasText = \"üìÖ Para la especialidad seleccionada,\\nbrindamos atenci√≥n en los siguientes d√≠as:\\n\\n\";\n\nconsole.log('üîÑ DEBUG: Starting days forEach with', Object.keys(diasObj).length, 'items');\nconsole.log('üîÑ DEBUG: Initial diasText:', diasText);\n\n// Check if we have any days to display\nif (Object.keys(diasObj).length === 0) {\n  console.log('‚ö†Ô∏è No days available for display');\n  diasText += \"‚ùå No hay d√≠as disponibles en este momento.\\n\\nPor favor intente m√°s tarde.\";\n  // Keep in previous state to allow retry\n  allSessions[chatId].estado = \"ESPERANDO_ESPECIALIDAD\";\n} else {\n  console.log('üîÑ Building days list with', Object.keys(diasObj).length, 'items');\n  \n  Object.keys(diasObj).forEach((key, index) => {\n    console.log(`üîÑ DEBUG: Processing day ${index + 1}:`, { key: key, value: diasObj[key] });\n    console.log(`üîÑ DEBUG: Before adding day ${index + 1}, text length:`, diasText.length);\n    \n    const listItem = `${key}. ${diasObj[key]}\\n`;\n    console.log(`üîÑ DEBUG: Adding item: \"${listItem}\"`);\n    \n    // Append directly to diasText to avoid string concatenation issues\n    diasText += listItem;\n    \n    console.log(`üîÑ DEBUG: After adding day ${index + 1}, text length:`, diasText.length);\n    console.log(`üîÑ DEBUG: Current diasText:`, diasText);\n    console.log(`‚úÖ Added day: ${key}. ${diasObj[key]}`);\n  });\n  \n  // Add multi-selection hint after all days are listed\n  diasText += \"\\n\\n‚úÖ Puede seleccionar uno o m√°s d√≠as respondiendo con los n√∫meros correspondientes,separados por comas.\\nüìù Ejemplo: 1,3,5\\n\\nüëâ Por favor, indique qu√© d√≠a o d√≠as prefiere para continuar con la reserva del turno.\";\n}\n\nconsole.log('‚úÖ DEBUG: Final diasText length:', diasText.length);\nconsole.log('‚úÖ DEBUG: Final diasText content:', diasText);\n\n// Clean message for WhatsApp\nconsole.log('üßπ DEBUG: Before cleaning, responseMessage:', diasText);\n\nlet cleanedMessage = diasText\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");\n\nconsole.log('üßπ DEBUG: After cleaning, cleanedMessage:', cleanedMessage);\nconsole.log('üìä DEBUG: Final cleaned message length:', cleanedMessage.length);\n\nconst result = {\n  json: {\n    chatId: chatId,\n    response: {\n      message: cleanedMessage\n    },\n    allSessions: allSessions,\n    timestamp: new Date().toISOString()\n  }\n};\n\nconsole.log('üì§ DEBUG: Final return result:', JSON.stringify(result, null, 2));\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1136,
        -480
      ],
      "id": "5529ff2f-7f15-4de0-b114-d9def679b84e",
      "name": "Process Days Result"
    },
    {
      "parameters": {
        "url": "=https://api.salmasalud.com.ar/rangos-horarios?idEspecialidad={{ $('Process State Logic').first().json.allSessions[$('Process State Logic').first().json.chatId].datos.especialidad.idEspecialidad }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Process State Logic').first().json.token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        944,
        -272
      ],
      "id": "6cc66d6a-5751-4058-8eb9-e1da02a03d3a",
      "name": "Get Hours"
    },
    {
      "parameters": {
        "jsCode": "// Process Hours Data - WITH EXTENSIVE DEBUGGING\nconst stateData = $('Process State Logic').first().json;\nconst chatId = stateData.chatId;\nlet allSessions = stateData.allSessions;\n\nconsole.log('üîç DEBUG: Starting Process Hours Result with chatId:', chatId);\nconsole.log('üîç DEBUG: State data:', JSON.stringify(stateData, null, 2));\n\n// Get hours from API response\n// FIXED: Use .all() instead of .first().json to get all items from the node\nconst horariosItems = $('Get Hours').all();\nlet horariosResponse = null;\n\nconsole.log('üìä Get Hours items count:', horariosItems.length);\nconsole.log('üìä Get Hours items structure:', JSON.stringify(horariosItems, null, 2));\n\nif (horariosItems && horariosItems.length > 0) {\n  // FIXED: Extract the actual data from all items and map to get the json data\n  horariosResponse = horariosItems.map(item => item.json);\n  console.log('üîç DEBUG: Raw hours data type:', typeof horariosResponse);\n  console.log('üîç DEBUG: Is hours an array?', Array.isArray(horariosResponse));\n  console.log('üîç DEBUG: Hours length:', horariosResponse?.length);\n  console.log('üîç DEBUG: All hours:', JSON.stringify(horariosResponse, null, 2));\n} else {\n  console.log('‚ö†Ô∏è No items returned from Get Hours node');\n  horariosResponse = null;\n}\n\nlet horariosObj = {};\n\nconsole.log('üîç DEBUG: Hours API Response:', JSON.stringify(horariosResponse, null, 2));\n\n// Process hours - handle both array and single object cases\nif (Array.isArray(horariosResponse)) {\n  console.log('‚úÖ Processing hours array with', horariosResponse.length, 'items');\n  horariosResponse.forEach((horario, index) => {\n    console.log(`üîÑ Processing hour ${index + 1}:`, horario);\n    if (horario.idRangoHorario && horario.descripcion) {\n      horariosObj[horario.idRangoHorario] = horario.descripcion;\n      console.log(`‚úÖ Added hour: ${horario.idRangoHorario}. ${horario.descripcion}`);\n    } else {\n      console.log('‚ö†Ô∏è Invalid hour object at index', index, ':', horario);\n    }\n  });\n} else if (horariosResponse && typeof horariosResponse === 'object' && horariosResponse.idRangoHorario && horariosResponse.descripcion) {\n  // FIXED: Handle single hour object case properly\n  console.log('‚úÖ Processing single hour object');\n  horariosObj[horariosResponse.idRangoHorario] = horariosResponse.descripcion;\n  console.log(`‚úÖ Added single hour: ${horariosResponse.idRangoHorario}. ${horariosResponse.descripcion}`);\n} else if (horariosResponse && typeof horariosResponse === 'object') {\n  // Handle other object formats (wrapped data, etc.)\n  console.log('‚ö†Ô∏è Unexpected object format for hours response, checking for wrapped data');\n  if (horariosResponse.data && Array.isArray(horariosResponse.data)) {\n    horariosResponse.data.forEach((horario, index) => {\n      if (horario.idRangoHorario && horario.descripcion) {\n        horariosObj[horario.idRangoHorario] = horario.descripcion;\n        console.log(`‚úÖ Added wrapped hour: ${horario.idRangoHorario}. ${horario.descripcion}`);\n      }\n    });\n  } else {\n    console.log('‚ö†Ô∏è Could not process object format:', horariosResponse);\n  }\n}\n\nconsole.log('üìä Final hours object:', JSON.stringify(horariosObj, null, 2));\n\n// Store hours data in session\nallSessions[chatId].datos.horariosDisponibles = horariosObj;\nallSessions[chatId].estado = \"ESPERANDO_HORARIO\";\n\n// Format hours for display\nlet horariosText = \"üïê Horarios disponibles para la especialidad seleccionada\\n\\nPor favor, indique el horario para continuar con la solicitud::\\n\\n\";\n\nconsole.log('üîÑ DEBUG: Starting hours forEach with', Object.keys(horariosObj).length, 'items');\nconsole.log('üîÑ DEBUG: Initial horariosText:', horariosText);\n\n// Check if we have any hours to display\nif (Object.keys(horariosObj).length === 0) {\n  console.log('‚ö†Ô∏è No hours available for display');\n  horariosText += \"‚ùå No hay horarios disponibles en este momento.\\n\\nPor favor intente m√°s tarde.\";\n  // Keep in previous state to allow retry\n  allSessions[chatId].estado = \"ESPERANDO_DIA\";\n} else {\n  console.log('üîÑ Building hours list with', Object.keys(horariosObj).length, 'items');\n  \n  Object.keys(horariosObj).forEach((key, index) => {\n    console.log(`üîÑ DEBUG: Processing hour ${index + 1}:`, { key: key, value: horariosObj[key] });\n    console.log(`üîÑ DEBUG: Before adding hour ${index + 1}, text length:`, horariosText.length);\n    \n    const listItem = `${key}. ${horariosObj[key]}\\n`;\n    console.log(`üîÑ DEBUG: Adding item: \"${listItem}\"`);\n    \n    // Append directly to horariosText to avoid string concatenation issues\n    horariosText += listItem;\n    \n    console.log(`üîÑ DEBUG: After adding hour ${index + 1}, text length:`, horariosText.length);\n    console.log(`üîÑ DEBUG: Current horariosText:`, horariosText);\n    console.log(`‚úÖ Added hour: ${key}. ${horariosObj[key]}`);\n  });\n  \n  // Add multi-selection hint after all hours are listed\n  horariosText += \"\\n\\n‚úÖ Puede seleccionar uno o m√°s rangos respondiendo con los n√∫meros correspondientes,separados por comas.\\nüìù Ejemplo: 1,3,5\\n\\nüëâ Por favor, indique qu√© d√≠a o d√≠as prefiere para continuar con la reserva del turno.\";\n}\n\nconsole.log('‚úÖ DEBUG: Final horariosText length:', horariosText.length);\nconsole.log('‚úÖ DEBUG: Final horariosText content:', horariosText);\n\n// Clean message for WhatsApp\nconsole.log('üßπ DEBUG: Before cleaning, responseMessage:', horariosText);\n\nlet cleanedMessage = horariosText\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");\n\nconsole.log('üßπ DEBUG: After cleaning, cleanedMessage:', cleanedMessage);\nconsole.log('üìä DEBUG: Final cleaned message length:', cleanedMessage.length);\n\nconst result = {\n  json: {\n    chatId: chatId,\n    response: {\n      message: cleanedMessage\n    },\n    allSessions: allSessions,\n    timestamp: new Date().toISOString()\n  }\n};\n\nconsole.log('üì§ DEBUG: Final return result:', JSON.stringify(result, null, 2));\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1136,
        -272
      ],
      "id": "9843ceef-ce32-41b8-aab3-c0ad07571967",
      "name": "Process Hours Result"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salmasalud.com.ar/solicitar",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Process State Logic').first().json.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"documento\": {{ JSON.stringify($('Process State Logic').first().json.allSessions[$('Process State Logic').first().json.chatId].datos.dni) }},\n  \"telefono\": {{ JSON.stringify($('Process State Logic').first().json.chatId.replace('@c.us', '')) }},\n  \"idEspecialidad\": {{ $('Process State Logic').first().json.allSessions[$('Process State Logic').first().json.chatId].datos.especialidad.idEspecialidad }},\n  \"dias\": [{{ $('Process State Logic').first().json.allSessions[$('Process State Logic').first().json.chatId].datos.diaSeleccionado.id }}],\n  \"rangosHorarios\": [{{ $('Process State Logic').first().json.allSessions[$('Process State Logic').first().json.chatId].datos.horarioSeleccionado.id }}]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        944,
        -64
      ],
      "id": "a66d1e14-7e9d-49fa-8c93-e18bc26752fd",
      "name": "Submit Turno",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Process API Submission Result - WITH EXTENSIVE DEBUGGING\nconst stateData = $('Process State Logic').first().json;\nconst chatId = stateData.chatId;\nlet allSessions = stateData.allSessions;\n\n// Check API response\nlet success = false;\nlet responseMessage = \"\";\nlet appointmentId = null;\n\ntry {\n  const apiResponse = $('Submit Turno').first().json;\n  \n  console.log('üîç DEBUG: Raw API Response:', JSON.stringify(apiResponse, null, 2));\n  console.log('üîç DEBUG: API Response type:', typeof apiResponse);\n  console.log('üîç DEBUG: Is API Response an array?', Array.isArray(apiResponse));\n  \n  // FIXED: Enhanced success detection logic to handle array responses like [57]\n  let isSuccessful = false;\n  \n  if (apiResponse) {\n    // Case 1: Traditional success indicators\n    if (apiResponse.success || apiResponse.id || apiResponse.idSolicitud) {\n      isSuccessful = true;\n      appointmentId = apiResponse.id || apiResponse.idSolicitud;\n      console.log('‚úÖ SUCCESS: Traditional success response detected');\n    }\n    // Case 2: Array response like [57] - this is the main fix\n    else if (Array.isArray(apiResponse) && apiResponse.length > 0) {\n      // Check if array contains valid appointment IDs (numbers > 0)\n      const validIds = apiResponse.filter(id => typeof id === 'number' && id > 0);\n      if (validIds.length > 0) {\n        isSuccessful = true;\n        appointmentId = validIds[0]; // Use first valid ID\n        console.log('‚úÖ SUCCESS: Array response with appointment ID:', appointmentId);\n      } else {\n        console.log('‚ö†Ô∏è Array response contains invalid IDs:', apiResponse);\n      }\n    }\n    // Case 3: Direct number response\n    else if (typeof apiResponse === 'number' && apiResponse > 0) {\n      isSuccessful = true;\n      appointmentId = apiResponse;\n      console.log('‚úÖ SUCCESS: Direct number response:', appointmentId);\n    }\n    // Case 4: Check for nested data\n    else if (apiResponse.data) {\n      if (Array.isArray(apiResponse.data) && apiResponse.data.length > 0) {\n        const validIds = apiResponse.data.filter(id => typeof id === 'number' && id > 0);\n        if (validIds.length > 0) {\n          isSuccessful = true;\n          appointmentId = validIds[0];\n          console.log('‚úÖ SUCCESS: Nested array data with appointment ID:', appointmentId);\n        }\n      } else if (typeof apiResponse.data === 'number' && apiResponse.data > 0) {\n        isSuccessful = true;\n        appointmentId = apiResponse.data;\n        console.log('‚úÖ SUCCESS: Nested number data:', appointmentId);\n      }\n    }\n    \n    console.log('üéØ Final success status:', isSuccessful);\n    console.log('üéØ Final appointment ID:', appointmentId);\n  } else {\n    console.log('‚ùå No API response received');\n  }\n  \n  if (isSuccessful) {\n    success = true;\n    allSessions[chatId].estado = \"COMPLETADO\";\n    \n    const userData = allSessions[chatId].datos;\n    const patientName = userData.paciente?.nombre || userData.paciente?.name || userData.paciente?.nombreCompleto || \"\";\n    \n    responseMessage =`‚úÖ Turno pre-reservado\\n\\n` +\n                     `Su solicitud fue recibida correctamente.\\n\\n` +\n                     `Por favor tenga en cuenta que su turno a√∫n est√° pendiente de confirmaci√≥n por parte del equipo deSalma Salud\\n\\n` +\n                     `Le llegar√° una confirmaci√≥n por este mismo medio una vez que el turno sea autorizado y confirmado.\\n\\n` +\n                     `Gracias por confiar en nosotros.\\n\\n\\n\\n` +\n                     `‚úÖ ¬°Turno agendado exitosamente!\\n\\n` +\n                     `üóÇÔ∏è N√∫mero de turno: ${appointmentId}\\n\\n` +\n                     `üìã Detalles:\\n` +\n                     (patientName ? `üë§ Paciente: ${patientName}\\n` : `üë§ DNI: ${userData.dni}\\n`) +\n                     `üè• Especialidad: ${userData.especialidad.descripcion}\\n` +\n                     `üìÖ D√≠a: ${userData.diaSeleccionado.descripcion}\\n` +\n                     `üïê Horario: ${userData.horarioSeleccionado.descripcion}\\n\\n` +\n                     `üìû Guarde este n√∫mero de turno para futuras consultas.\\n\\n` +\n                     `¬°Gracias por usar nuestro sistema!`;\n                     \n    console.log('‚úÖ SUCCESS MESSAGE: Generated success response');\n  } else {\n    responseMessage = \"‚ùå Error al procesar la solicitud\\n\\nPor favor intente nuevamente m√°s tarde o comun√≠quese directamente con la cl√≠nica.\";\n    // Keep in confirmation state to allow retry\n    allSessions[chatId].estado = \"ESPERANDO_CONFIRMACION\";\n    console.log('‚ùå ERROR MESSAGE: Generated error response');\n  }\n} catch (error) {\n  console.log('‚ùå API Submission Error:', error.message);\n  console.log('‚ùå Error stack:', error.stack);\n  responseMessage = \"‚ùå Error al procesar la solicitud\\n\\nPor favor intente nuevamente m√°s tarde o comun√≠quese directamente con la cl√≠nica.\";\n  allSessions[chatId].estado = \"ESPERANDO_CONFIRMACION\";\n}\n\n// Clean message for WhatsApp\nlet cleanedMessage = responseMessage\n  .replace(/\\\\*\\\\*([^*]+)\\\\*\\\\*/g, \"$1\")\n  .replace(/^\\\\s*-\\\\s+/gm, \"- \");\n\nconsole.log('üì§ Final response message:', cleanedMessage);\n\nreturn {\n  json: {\n    chatId: chatId,\n    response: {\n      message: cleanedMessage\n    },\n    allSessions: allSessions,\n    success: success,\n    appointmentId: appointmentId,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1136,
        -64
      ],
      "id": "83e4c2be-74b2-4820-a5ac-38d6899bd009",
      "name": "Process API Result"
    },
    {
      "parameters": {
        "jsCode": "// Merge All Responses\nconst stateData = $('Process State Logic').first().json;\n\n// üîç EXECUTION TRACKING - Merge Responses\nconst mergeExecutionId = Math.random().toString(36).substr(2, 9);\nconsole.log('üîç EXECUTION START - Merge Responses:', mergeExecutionId);\nconsole.log('üîç Process State Logic executionId received:', stateData?.executionId);\nconsole.log('üîÑ Merge Responses: Starting with state data:', JSON.stringify(stateData, null, 2));\nconsole.log('üîÑ Merge Responses: isValid =', stateData.isValid);\n\n// Check if we have responses from other nodes\nlet finalResponse = stateData.response;\nlet finalAllSessions = stateData.allSessions;\n\n// CRITICAL FIX: If validation failed (isValid = false), use the error message from Process State Logic directly\nif (stateData.isValid === false) {\n  console.log('‚ùå Merge Responses: Validation failed, using error response directly');\n  console.log('‚ùå Error response message:', stateData.response.message);\n  \n  // Use the error response from Process State Logic directly\n  return {\n    json: {\n      chatId: stateData.chatId,\n      response: stateData.response,\n      allSessions: stateData.allSessions,\n      timestamp: new Date().toISOString(),\n      source: 'error_routing'\n    }\n  };\n}\n\n// For valid responses, check for results from processing nodes\nconsole.log('‚úÖ Merge Responses: Validation passed, checking processing nodes');\n\n// Check for DNI validation result\ntry {\n  const dniResult = $('Process DNI Result').first()?.json;\n  if (dniResult && dniResult.response) {\n    console.log('üìã Using DNI result response');\n    finalResponse = dniResult.response;\n    finalAllSessions = dniResult.allSessions;\n  } else {\n    console.log('‚ö†Ô∏è No DNI result available (likely skipped due to format validation failure)');\n    console.log('‚ö†Ô∏è DNI node executed but returned empty array to prevent duplicates');\n  }\n} catch (error) {\n  console.log('‚ö†Ô∏è No DNI result available - node may have returned empty array to prevent duplicate errors');\n}\n\n// Check for days result\ntry {\n  const daysResult = $('Process Days Result').first()?.json;\n  if (daysResult && daysResult.response) {\n    console.log('üìã Using Days result response');\n    finalResponse = daysResult.response;\n    finalAllSessions = daysResult.allSessions;\n  }\n} catch (error) {\n  console.log('‚ö†Ô∏è No Days result available');\n}\n\n// Check for hours result\ntry {\n  const hoursResult = $('Process Hours Result').first()?.json;\n  if (hoursResult && hoursResult.response) {\n    console.log('üìã Using Hours result response');\n    finalResponse = hoursResult.response;\n    finalAllSessions = hoursResult.allSessions;\n  }\n} catch (error) {\n  console.log('‚ö†Ô∏è No Hours result available');\n}\n\n// Check for API submission result\ntry {\n  const apiResult = $('Process API Result').first()?.json;\n  if (apiResult && apiResult.response) {\n    console.log('üìã Using API result response');\n    finalResponse = apiResult.response;\n    finalAllSessions = apiResult.allSessions;\n  }\n} catch (error) {\n  console.log('‚ö†Ô∏è No API result available');\n}\n\nconsole.log('üì§ Merge Responses: Final response:', JSON.stringify(finalResponse, null, 2));\nconsole.log('üì§ Merge Responses: Final response message preview:', finalResponse?.message?.substring(0, 100) + '...');\n\nreturn {\n  json: {\n    chatId: stateData.chatId,\n    response: finalResponse,\n    allSessions: finalAllSessions,\n    timestamp: new Date().toISOString(),\n    source: 'normal_flow'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1552,
        -304
      ],
      "id": "1b538395-a48b-43bd-bac0-fd46605f13d9",
      "name": "Merge Responses"
    },
    {
      "parameters": {
        "jsCode": "// Update Session - MANEJO DE USUARIOS NUEVOS\nconst mergeData = $('Merge Responses').first().json;\nconst chatId = mergeData.chatId;\nconst newState = mergeData.allSessions[chatId]?.estado;\nconst sessionData = mergeData.allSessions[chatId]?.datos;\n\n// Obtener JSONBin actual o crear estructura vac√≠a si no existe\nlet allSessions = {};\ntry {\n  // En este punto ya tenemos los datos procesados de mergeData\n  allSessions = mergeData.allSessions;\n  console.log('‚úÖ JSONBin data loaded, total users:', Object.keys(allSessions).length);\n} catch (error) {\n  console.log('‚ùå Error reading JSONBin, creating new structure:', error.message);\n  allSessions = {};\n}\n\n// Crear o actualizar sesi√≥n del usuario\nconst isNewUser = !allSessions[chatId]?.createdAt;\n\nif (allSessions[chatId]) {\n  allSessions[chatId] = {\n    chatId: chatId,\n    estado: newState,\n    datos: sessionData,\n    createdAt: isNewUser ? new Date().toISOString() : (allSessions[chatId]?.createdAt || new Date().toISOString()),\n    updatedAt: new Date().toISOString(),\n    lastActivity: new Date().toISOString()\n  };\n}\n\nconsole.log(isNewUser ? 'üÜï Created new user session' : 'üîÑ Updated existing user session');\nconsole.log('User state:', newState);\nconsole.log('Session data:', JSON.stringify(sessionData, null, 2));\n\n// Preparar estructura completa para JSONBin\nconst jsonbinData = {\n  sessions: allSessions\n};\n\nreturn {\n  json: {\n    chatId: chatId,\n    jsonbinData: jsonbinData,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1632,
        -688
      ],
      "id": "5232d614-73c1-43d3-98ae-cc147d5ec34a",
      "name": "Prepare JSONBin Update"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "https://api.jsonbin.io/v3/b/687566205d646f1c273fa03e",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Master-Key",
              "value": "$2a$10$x6g.oxG8TSRAhrOyGXNhjOcipTIiu9RU3X/h2S0DC4kbIalK9KxEO"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.jsonbinData }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1936,
        -768
      ],
      "id": "3231e7a6-7606-4992-b666-8eadb2f04834",
      "name": "Update JSONBin"
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for WhatsApp\nconst mergeData = $('Merge Responses').first().json;\n\nreturn {\n  json: {\n    chatId: mergeData.chatId,\n    message: mergeData.response.message\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1856,
        -320
      ],
      "id": "44d61da3-849b-4398-8260-cd6854e43123",
      "name": "Prepare WhatsApp Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://waapi.app/api/v1/instances/82249/client/action/send-message ",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer RnfskkYrbR0Sh2Acnr5B9GwPDl545m1jPPKDbccoa2ab2e89"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chatId\": {{ JSON.stringify($json.chatId) }},\n  \"message\": {{ JSON.stringify($json.message) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2176,
        -480
      ],
      "id": "7620a748-34a6-4475-989e-72b59ac7c22d",
      "name": "Send WhatsApp"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        384,
        -384
      ],
      "id": "0eb16664-a8ec-4fb3-9b1c-2768f8cc4f14",
      "name": "Merge"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5c457be5-c7a5-49c9-8598-b88aad58cd17",
              "leftValue": "={{ $json.isCanceled }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        720,
        272
      ],
      "id": "120a74f3-c3c0-4cec-9b16-8e1f29541d3c",
      "name": "Cancelturno"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook Start": {
      "main": [
        [
          {
            "node": "Parse Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Message": {
      "main": [
        [
          {
            "node": "Get Auth Token",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get User Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Auth Token": {
      "main": [
        [
          {
            "node": "Get Especialidades",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Session": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Process State Logic": {
      "main": [
        [
          {
            "node": "Check Error Routing",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Initial State",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check DNI Validation",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Days Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Hours Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check API Submission",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Confirmation Display",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cancelturno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Error Routing": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Initial State": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check DNI Validation": {
      "main": [
        [
          {
            "node": "Validate DNI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Days Data": {
      "main": [
        [
          {
            "node": "Get Days",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Hours Data": {
      "main": [
        [
          {
            "node": "Get Hours",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check API Submission": {
      "main": [
        [
          {
            "node": "Submit Turno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Confirmation Display": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate DNI": {
      "main": [
        [
          {
            "node": "Process DNI Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process DNI Result": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Days": {
      "main": [
        [
          {
            "node": "Process Days Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Days Result": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Hours": {
      "main": [
        [
          {
            "node": "Process Hours Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Hours Result": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Submit Turno": {
      "main": [
        [
          {
            "node": "Process API Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process API Result": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Responses": {
      "main": [
        [
          {
            "node": "Prepare JSONBin Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare JSONBin Update": {
      "main": [
        [
          {
            "node": "Update JSONBin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update JSONBin": {
      "main": [
        [
          {
            "node": "Prepare WhatsApp Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare WhatsApp Message": {
      "main": [
        [
          {
            "node": "Send WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Especialidades": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Process State Logic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelturno": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "11189562-b106-4160-ba54-f1d29b1767f5",
  "meta": {
    "instanceId": "556514cf317cac5c724bf084ccbb32127ff27cc56f225fb39f131295f3c7f3d0"
  },
  "id": "v8eKjjtCYC1WyQw8",
  "tags": []
}